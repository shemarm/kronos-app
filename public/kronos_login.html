<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>K.R.O.N.O.S ‚Äì Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #020617;
      --accent: #2d8cff;
      --accent-soft: rgba(45, 140, 255, 0.18);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --card-bg: #020617;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --radius: 20px;
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #1e293b 0, transparent 50%),
        radial-gradient(circle at bottom right, #0f172a 0, transparent 50%),
        #020617;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .shell {
      width: min(1080px, 100%);
    }

    .brand-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-inline: 4px;
    }

    .brand-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8 0, #2563eb 40%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #e5f0ff;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.7);
    }

    .brand-text-main {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .brand-right {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    .login-card {
      display: grid;
      grid-template-columns: 1.2fr 1.4fr;
      background:
        radial-gradient(circle at top, rgba(148, 163, 184, 0.18) 0, transparent 55%),
        radial-gradient(circle at bottom right, rgba(34, 197, 94, 0.14) 0, transparent 45%),
        var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.4);
      overflow: hidden;
    }

    .login-aside {
      padding: 22px 22px 20px;
      border-right: 1px solid rgba(148, 163, 184, 0.35);
      background:
        radial-gradient(circle at top left, rgba(15, 23, 42, 0.6) 0, transparent 55%),
        linear-gradient(180deg, #020617 0, #020617 100%);
      position: relative;
    }

    .login-aside-tag {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .login-aside-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .login-aside-role {
      font-size: 14px;
      margin-bottom: 10px;
      color: var(--text-muted);
    }

    .login-aside-points {
      list-style: none;
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .login-aside-points li::before {
      content: "‚Ä¢";
      margin-right: 6px;
      color: rgba(96, 165, 250, 0.9);
    }

    .login-aside-foot {
      position: absolute;
      bottom: 16px;
      left: 22px;
      right: 22px;
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.9;
    }

    .login-main {
      padding: 22px 22px 20px;
      background:
        radial-gradient(circle at top right, rgba(37, 99, 235, 0.25) 0, transparent 60%),
        radial-gradient(circle at bottom left, rgba(34, 197, 94, 0.18) 0, transparent 55%),
        #020617;
    }

    .role-tabs {
      display: inline-flex;
      border-radius: 999px;
      padding: 3px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      margin-bottom: 14px;
    }

    .role-tab {
      border: none;
      background: transparent;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background 0.16s ease, color 0.16s ease, transform 0.1s ease;
    }

    .role-tab-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.7);
    }

    .role-tab.active {
      background: var(--accent-soft);
      color: #e5f0ff;
      transform: translateY(-1px);
    }

    .role-tab.active .role-tab-dot {
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.35);
    }

    .login-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .login-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 9px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field-input {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      padding: 8px 9px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
      width: 100%;
    }

    .field-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
    }

    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .password-wrapper .field-input {
      padding-right: 34px;
    }

    .toggle-password {
      position: absolute;
      right: 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2px;
    }

    .login-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .btn-primary {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.28) 0, rgba(37, 99, 235, 0.30) 100%);
      color: var(--text-main);
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s ease;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.38) 0, rgba(37, 99, 235, 0.40) 100%);
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.5);
    }

    .login-note {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      padding-top: 4px;
    }

    .error-msg {
      font-size: 12px;
      color: #f87171;
      text-align: center;
      min-height: 18px;
    }

    @media (max-width: 800px) {
      .login-card {
        grid-template-columns: minmax(0, 1fr);
      }
      .login-aside {
        display: none;
      }
    }

    @media (max-width: 500px) {
      .brand-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
    }
  </style>
</head>
<body>
<div class="shell">
  <header class="brand-header">
    <div class="brand-left">
      <div class="brand-logo">KR</div>
      <div>
        <div class="brand-text-main">K.R.O.N.O.S</div>
        <div class="brand-sub">Knowledge-driven Recording of Operations, Notifications & Organized Schedules</div>
      </div>
    </div>
    <div class="brand-right">
      St. Ann's Bay Regional Hospital<br/>
      <span style="opacity:0.8;">Digital Attendance Portal</span>
    </div>
  </header>

  <section class="login-card">
    <!-- LEFT -->
    <aside class="login-aside">
      <div class="login-aside-tag">Secure access</div>
      <div class="login-aside-title" id="asideTitle">Employee portal</div>
      <div class="login-aside-role" id="asideRole">
        Sign in to view shifts, clock-in history and leave balances.
      </div>
      <ul class="login-aside-points" id="asidePoints">
        <li>Real-time QR attendance tracking.</li>
        <li>View upcoming shifts and work hours.</li>
        <li>Submit leave and missed punch requests.</li>
      </ul>
      <div class="login-aside-foot">
        By signing in, you confirm that you are an authorized user of the hospital's
        attendance and scheduling system.
      </div>
    </aside>

    <!-- RIGHT -->
    <main class="login-main">
      <div class="role-tabs" id="roleTabs">
        <button class="role-tab active" data-role="employee">
          <span class="role-tab-dot"></span>
          Employee
        </button>
        <button class="role-tab" data-role="hr">
          <span class="role-tab-dot"></span>
          HR / Manager
        </button>
      </div>

      <h1 class="login-title" id="formTitle">Employee sign in</h1>
      <p class="login-subtitle" id="formSubtitle">
        Use your staff ID and password to access your attendance and shift information.
      </p>

      <form class="login-form" id="loginForm">
        <div class="field">
          <label class="field-label" id="userLabel">Staff ID / Username</label>
          <input type="text" class="field-input" id="username" required />
        </div>
        <div class="field">
          <label class="field-label">Password</label>
          <div class="password-wrapper">
            <input type="password" class="field-input" id="password" required />
            <button type="button" class="toggle-password" id="togglePassword" aria-label="Show password">
              üëÅ
            </button>
          </div>
        </div>

        <div class="login-row">
          <span id="hintText">Employees: contact HR if you do not have your login yet.</span>
        </div>

        <button type="submit" class="btn-primary" id="submitBtn">
          <span>‚Æû</span>
          <span id="submitText">Sign in as Employee</span>
        </button>

        <p class="login-note" id="loginNote">
          After signing in, you will be redirected to the K.R.O.N.O.S dashboard.
        </p>

        <div class="error-msg" id="errorMsg"></div>
      </form>
    </main>
  </section>
</div>

<script>
  // Text config per role
  const roleConfig = {
    employee: {
      formTitle: "Employee sign in",
      formSubtitle:
        "Use your staff ID and password to access your attendance and shift information.",
      asideTitle: "Employee portal",
      asideRole: "Sign in to view shifts, clock-in history and leave balances.",
      asidePoints: [
        "Real-time QR attendance tracking.",
        "View upcoming shifts and work hours.",
        "Submit leave and missed punch requests."
      ],
      submitText: "Sign in as Employee",
      hintText: "Employees: contact HR if you do not have your login yet.",
      userLabel: "Staff ID / Username"
    },
    hr: {
      formTitle: "HR / Manager sign in",
      formSubtitle:
        "Access attendance exceptions, approve leave and publish official schedules.",
      asideTitle: "HR & Management console",
      asideRole: "Analyze presence patterns, investigate exceptions and manage staffing.",
      asidePoints: [
        "View lateness, absences and overtime patterns.",
        "Approve or reject leave and correction requests.",
        "Manage shifts, departments and staff allocations."
      ],
      submitText: "Sign in as HR / Manager",
      hintText: "HR/Managers: use your HR credentials issued by IT.",
      userLabel: "HR username"
    }
  };

  // Mock credentials for testing (fallback when server is unavailable)
  const MOCK_USERS = {
    "employee1": { id: 1, username: "employee1", displayName: "Sarah Johnson", role: "employee", roleId: 1 },
    "employee2": { id: 2, username: "employee2", displayName: "Michael Chen", role: "employee", roleId: 1 },
    "emp001": { id: 3, username: "emp001", displayName: "Emily Rodriguez", role: "employee", roleId: 1 },
    "hr1": { id: 100, username: "hr1", displayName: "Admin Manager", role: "hr", roleId: 2 },
    "hradmin": { id: 101, username: "hradmin", displayName: "HR Director", role: "hr", roleId: 2 }
  };
  
  const MOCK_PASSWORDS = {
    "employee1": "emp123", 
    "employee2": "emp123", 
    "emp001": "emp123",
    "hr1": "hr123", 
    "hradmin": "hr123"
  };

  const roleTabs   = document.querySelectorAll(".role-tab");
  const formTitle  = document.getElementById("formTitle");
  const formSubtitle = document.getElementById("formSubtitle");
  const asideTitle = document.getElementById("asideTitle");
  const asideRole  = document.getElementById("asideRole");
  const asidePoints = document.getElementById("asidePoints");
  const submitText = document.getElementById("submitText");
  const hintText   = document.getElementById("hintText");
  const userLabel  = document.getElementById("userLabel");
  const loginNote  = document.getElementById("loginNote");
  const loginForm  = document.getElementById("loginForm");
  const errorMsg   = document.getElementById("errorMsg");
  const usernameEl = document.getElementById("username");
  const passwordEl = document.getElementById("password");
  const togglePasswordBtn = document.getElementById("togglePassword");

  let currentRole = "employee";

  function updateRole(role) {
    currentRole = role;
    const cfg = roleConfig[role];

    formTitle.textContent = cfg.formTitle;
    formSubtitle.textContent = cfg.formSubtitle;
    asideTitle.textContent = cfg.asideTitle;
    asideRole.textContent = cfg.asideRole;
    submitText.textContent = cfg.submitText;
    hintText.textContent = cfg.hintText;
    userLabel.textContent = cfg.userLabel;

    asidePoints.innerHTML = "";
    cfg.asidePoints.forEach(text => {
      const li = document.createElement("li");
      li.textContent = text;
      asidePoints.appendChild(li);
    });

    loginNote.textContent =
      "After signing in as " +
      cfg.formTitle.replace(" sign in", "") +
      ", you will be redirected to the K.R.O.N.O.S dashboard.";

    roleTabs.forEach(tab => {
      tab.classList.toggle("active", tab.dataset.role === role);
    });

    errorMsg.textContent = "";
    usernameEl.value = "";
    passwordEl.value = "";
  }

  roleTabs.forEach(tab => {
    tab.addEventListener("click", () => updateRole(tab.dataset.role));
  });

  updateRole("employee");

  // Password visibility toggle
  togglePasswordBtn.addEventListener("click", () => {
    const currentType = passwordEl.getAttribute("type");
    const isPassword = currentType === "password";
    passwordEl.setAttribute("type", isPassword ? "text" : "password");
    togglePasswordBtn.textContent = isPassword ? "üôà" : "üëÅ";
    togglePasswordBtn.setAttribute("aria-label", isPassword ? "Hide password" : "Show password");
  });

  // Helper function for mock authentication
  function attemptMockLogin(userInput, passInput) {
    const mockUser = MOCK_USERS[userInput.toLowerCase()];
    if (mockUser && MOCK_PASSWORDS[userInput.toLowerCase()] === passInput && mockUser.role === currentRole) {
      mockUser.dbId = mockUser.id;
      localStorage.setItem("kronosUser", JSON.stringify(mockUser));
      localStorage.setItem("kronosRole", mockUser.role);
      window.location.href = "kronos_dashboard.html";
      return true;
    }
    return false;
  }

  // Login handler - tries API first, falls back to mock credentials
  loginForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    errorMsg.textContent = "";

    const userInput = usernameEl.value.trim();
    const passInput = passwordEl.value;

    if (!userInput || !passInput) {
      errorMsg.textContent = "Please enter your username and password.";
      return;
    }

    try {
      // Attempt API authentication first
      const response = await fetch("/api/auth/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          userId: userInput,
          password: passInput
        })
      });

      let data = null;
      try {
        data = await response.json();
      } catch (err) {
        data = null;
      }

      if (response.ok) {
        // API authentication successful
        const user = data && data.user ? data.user : data;

        // Derive a frontend role string from the backend user data
        const derivedRole =
          user && (user.roleId === 2 || user.role === "hr" || user.role === "HR")
            ? "hr"
            : "employee";

        try {
          if (user) {
            user.dbId = user.id;
            localStorage.setItem("kronosUser", JSON.stringify(user));
          }
          localStorage.setItem("kronosRole", derivedRole);
        } catch (err) {
          console.warn("Could not persist login", err);
        }

        window.location.href = "kronos_dashboard.html";
        return;
      }

      // API returned error - try mock authentication
      if (attemptMockLogin(userInput, passInput)) {
        return;
      }

      // Neither API nor mock succeeded
      const msg = data && data.message ? data.message : "Invalid username or password.";
      errorMsg.textContent = msg + " (Try: employee1/emp123 or hr1/hr123)";

    } catch (err) {
      // Server unavailable - try mock authentication
      console.error("Login error:", err);
      
      if (attemptMockLogin(userInput, passInput)) {
        return;
      }

      errorMsg.textContent = "Server unavailable. Try mock credentials: employee1/emp123 or hr1/hr123";
    }
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>K.R.O.N.O.S ‚Äì Attendance Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.22);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --card-bg: #020617;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --radius: 20px;
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #app {
      width: 100%;
      max-width: 1200px;
      margin: 24px 16px;
    }

    .hidden {
      display: none !important;
    }

    /* LOGIN SCREEN ‚Äì HOSPITAL UI */

    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }

    .login-shell {
      width: 100%;
      max-width: 1100px;
      border-radius: 26px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #020617 100%);
      box-shadow: 0 28px 80px rgba(15, 23, 42, 0.9);
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
    }

    @media (max-width: 900px) {
      .login-shell {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .login-panel {
      padding: 32px 32px 28px;
    }

    .login-panel-left {
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.20), transparent 55%),
        radial-gradient(circle at bottom right, rgba(52, 211, 153, 0.16), transparent 60%),
        #020617;
      border-right: 1px solid rgba(30, 64, 175, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 32px;
    }

    .login-panel-right {
      background:
        radial-gradient(circle at top right, rgba(37, 99, 235, 0.32), transparent 65%),
        radial-gradient(circle at bottom, rgba(15, 23, 42, 0.95), #020617);
      position: relative;
    }

    .login-brand-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      gap: 12px;
    }

    .login-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, #22d3ee, #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      border: 1px solid rgba(56, 189, 248, 0.8);
      box-shadow: 0 10px 30px rgba(8, 47, 73, 0.8);
    }

    .brand-text-main {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: 0.22em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: #cbd5f5;
    }

    .login-hospital-tag {
      font-size: 11px;
      text-align: right;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .left-section-title {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #7dd3fc;
      margin-bottom: 6px;
    }

    .left-main-heading {
      font-size: 23px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .left-subtext {
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 12px;
    }

    .left-list {
      list-style: disc;
      padding-left: 18px;
      font-size: 13px;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .left-footer {
      font-size: 11px;
      color: var(--text-muted);
      max-width: 420px;
    }

    .right-inner {
      max-width: 430px;
      margin-left: auto;
    }

    .role-toggle {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.85);
      margin-bottom: 18px;
      gap: 4px;
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.9);
    }

    .role-pill {
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 12px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .role-pill.active {
      background: linear-gradient(135deg, #38bdf8, #4f46e5);
      color: #e0f2fe;
    }

    .login-main-heading {
      font-size: 21px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .login-main-sub {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .field-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .field {
      margin-bottom: 16px;
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, transform 0.08s ease;
    }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: rgba(15, 23, 42, 0.98);
      transform: translateY(-0.5px);
    }

    .input-with-toggle {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-with-toggle .input {
      padding-right: 34px;
    }

    .eye-btn {
      position: absolute;
      right: 10px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .eye-btn:hover {
      color: #e5e7eb;
    }

    .btn-primary {
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #4f46e5);
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.65);
      margin-top: 4px;
    }

    .btn-primary:hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 12px 26px rgba(30, 64, 175, 0.7);
    }

    .login-hint {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .login-footer-text {
      margin-top: 18px;
      font-size: 11px;
      color: var(--text-muted);
      max-width: 420px;
    }

    .error {
      margin-top: 6px;
      font-size: 12px;
      color: #f97373;
      text-align: center;
    }

    /* DASHBOARD LAYOUT */

    #dashboard-screen {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: var(--shadow);
      padding: 18px 20px 22px;
    }

    .dash-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(56, 189, 248, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: radial-gradient(circle at top left, rgba(45, 212, 191, 0.35), rgba(15, 23, 42, 0.95));
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .nav {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .nav-link {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-muted);
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, border 0.15s ease;
    }

    .nav-link:hover {
      background: rgba(15, 23, 42, 0.85);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-main);
    }

    .nav-link.active {
      background: rgba(37, 99, 235, 0.22);
      border-color: rgba(59, 130, 246, 0.7);
      color: #bfdbfe;
    }

    .user-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
    }

    .btn-ghost {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      color: var(--text-main);
      font-size: 11px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, border 0.15s ease;
    }

    .btn-ghost:hover {
      background: rgba(148, 163, 184, 0.12);
    }

    /* Notification bell */

    .notif-wrapper {
      position: relative;
    }

    .notif-btn {
      position: relative;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .notif-count {
      min-width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #f97316;
      color: white;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .notif-dropdown {
      position: absolute;
      right: 0;
      margin-top: 6px;
      width: 260px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      padding: 10px 10px 8px;
      z-index: 20;
    }

    .notif-dropdown h4 {
      font-size: 12px;
      margin-bottom: 6px;
      color: var(--text-muted);
    }

    .notif-list {
      list-style: none;
      max-height: 220px;
      overflow-y: auto;
    }

    .notif-list li {
      padding: 6px 4px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.75);
    }

    .notif-actions {
      display: flex;
      gap: 6px;
    }

    .notif-actions button {
      flex: 1;
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    .notif-approve {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    .notif-reject {
      background: rgba(239, 68, 68, 0.16);
      color: #fecaca;
    }

    /* CONTENT */

    .dash-main {
      margin-top: 8px;
      border-radius: 18px;
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.35), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 14px 16px 16px;
    }

    .view-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .view-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .grid {
      display: grid;
      gap: 10px;
    }

    @media (min-width: 900px) {
      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      border-radius: 14px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 12px;
      font-size: 13px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #e0f2fe;
    }

    .metric {
      font-size: 18px;
      font-weight: 600;
      margin-top: 2px;
    }

    .muted {
      font-size: 11px;
      color: var(--text-muted);
    }

    .section {
      margin-top: 6px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .section-body {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* FORMS + TABLES */

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .form-row .field {
      flex: 1;
      min-width: 120px;
      margin-bottom: 0;
    }

    .btn-small {
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      background: rgba(37, 99, 235, 0.9);
      color: white;
      font-size: 11px;
      cursor: pointer;
      margin-top: 2px;
    }

    .btn-small:hover {
      background: rgba(59, 130, 246, 0.95);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }

    th,
    td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(30, 64, 175, 0.7);
      text-align: left;
    }

    th {
      font-weight: 500;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .pill-status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 1px 8px;
      font-size: 10px;
    }

    /* Leave actions dropdown for HR */
    .leave-actions-wrapper {
      display: inline-flex;
      align-items: center;
      margin-left: 6px;
      position: relative;
    }

    .leave-action-toggle {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      padding: 1px 6px;
      margin-left: 4px;
      cursor: pointer;
    }

    .leave-action-toggle:hover {
      background: rgba(148, 163, 184, 0.16);
      color: #e5e7eb;
    }

    .leave-action-menu {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 2px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
      min-width: 120px;
      z-index: 30;
      display: flex;
      flex-direction: column;
    }

    .leave-action-menu button {
      background: transparent;
      border: none;
      color: #e5e7eb;
      font-size: 11px;
      padding: 5px 10px;
      text-align: left;
      cursor: pointer;
    }

    .leave-action-menu button:hover {
      background: rgba(37, 99, 235, 0.18);
    }

    .leave-action-menu button.leave-action-reject:hover {
      background: rgba(239, 68, 68, 0.18);
    }

    .status-pending {
      background: rgba(234, 179, 8, 0.17);
      color: #facc15;
    }

    .status-approved {
      background: rgba(34, 197, 94, 0.18);
      color: #86efac;
    }

    .status-rejected {
      background: rgba(239, 68, 68, 0.16);
      color: #fecaca;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }

    .chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
    }

    #workHoursTable {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 15px;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
    }

    #workHoursTable th {
      text-transform: none;
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      background: transparent;
    }

    #workHoursTable td {
      padding: 16px 16px;
      vertical-align: middle;
      border-bottom: 1px solid rgba(51, 65, 85, 0.3);
      color: #f8fafc;
    }

    .time-stack {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .time-date {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .time-entry {
      font-weight: 500;
      font-size: 13px;
      color: #e2e8f0;
    }

    .time-entry span {
      color: #94a3b8;
      font-size: 11px;
      margin-right: 4px;
      font-weight: 600;
    }

    .duration-main {
      color: #4ade80;
      font-family: monospace;
      font-size: 13px;
      letter-spacing: 0.5px;
    }

    .duration-sub {
      font-size: 11px;
      color: #64748b;
      margin-top: 2px;
    }

    .duration-incomplete {
      color: #facc15;
      font-family: monospace;
      font-size: 13px;
      letter-spacing: 0.5px;
    }

    .status-text-progress {
      color: #facc15;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
    }

    .status-text-complete {
      color: #e2e8f0;
      font-weight: 400;
      font-size: 13px;
    }

    .audit-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      min-width: 80px;
    }

    .audit-in {
      background: rgba(234, 179, 8, 0.15);
      border: 1px solid rgba(234, 179, 8, 0.3);
      color: #facc15;
    }

    .audit-synced {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    .table-footer-total {
      text-align: right;
      padding: 12px 16px;
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
      text-transform: uppercase;
      border-top: 1px solid rgba(51, 65, 85, 0.5);
    }

    .total-highlight {
      color: #e2e8f0;
      font-weight: 700;
      margin-left: 4px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <div id="app">
    <!-- LOGIN SCREEN -->
    <section id="login-screen">
      <div id="login-shell" class="login-shell" data-role="employee">
        <!-- LEFT PANEL -->
        <div class="login-panel login-panel-left">
          <div>
            <div class="login-brand-row">
              <div class="login-brand">
                <div class="brand-logo">KR</div>
                <div>
                  <div class="brand-text-main">K.R.O.N.O.S</div>
                  <div class="brand-text-sub">
                    Knowledge-driven Recording of Operations, Notifications &amp; Organized Schedules
                  </div>
                </div>
              </div>
              <div class="login-hospital-tag">
                St. Ann‚Äôs Bay Regional Hospital<br />
                Digital Attendance Portal
              </div>
            </div>

            <div id="left-copy-employee">
              <div class="left-section-title">Secure access</div>
              <div class="left-main-heading">Employee portal</div>
              <div class="left-subtext">
                Sign in to view shifts, clock-in history and leave balances.
              </div>
              <ul class="left-list">
                <li>Real-time QR attendance tracking.</li>
                <li>View upcoming shifts and work hours.</li>
                <li>Submit leave and missed punch requests.</li>
              </ul>
            </div>

            <div id="left-copy-hr" class="hidden">
              <div class="left-section-title">Secure access</div>
              <div class="left-main-heading">HR &amp; Management console</div>
              <div class="left-subtext">
                Analyze presence patterns, investigate exceptions and manage staffing.
              </div>
              <ul class="left-list">
                <li>View lateness, absences and overtime patterns.</li>
                <li>Approve or reject leave and correction requests.</li>
                <li>Manage shifts, departments and staff allocations.</li>
              </ul>
            </div>
          </div>

          <div class="left-footer">
            By signing in, you confirm that you are an authorized user of the hospital‚Äôs attendance and scheduling
            system.
          </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="login-panel login-panel-right">
          <div class="right-inner">
            <div class="role-toggle">
              <button id="toggle-employee" class="role-pill active">Employee</button>
              <button id="toggle-hr" class="role-pill">HR / Manager</button>
            </div>

            <h2 id="login-main-heading" class="login-main-heading">Employee sign in</h2>
            <p id="login-main-sub" class="login-main-sub">
              Use your staff ID and password to access your attendance and shift information.
            </p>

            <form id="login-form">
              <input type="hidden" id="role" value="employee" />

              <div class="field">
                <div class="field-label">Staff ID / Username</div>
                <input id="username" type="text" class="input" autocomplete="off" />
              </div>

              <div class="field">
                <div class="field-label">Password</div>
                <div class="input-with-toggle">
                  <input id="password" type="password" class="input" autocomplete="off" />
                  <button type="button" id="toggle-password" class="eye-btn" aria-label="Show password">üëÅ</button>
                </div>
              </div>

              <button type="submit" class="btn-primary" id="login-submit-btn">
                <span id="sign-in-label">Sign in as Employee</span>
              </button>
              <div id="login-error" class="error hidden"></div>
            </form>

            <p id="login-hint-employee" class="login-hint">
              Employees: contact HR if you do not have your login yet.
            </p>
            <p id="login-hint-hr" class="login-hint hidden">
              HR/Managers: use your HR credentials issued by IT.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD SCREEN -->
    <section id="dashboard-screen" class="hidden">
      <header class="dash-header">
        <div class="brand">
          <div class="brand-icon">‚è±</div>
          <div>
            <div class="brand-title">K.R.O.N.O.S</div>
            <div class="brand-sub">Smart attendance, shift &amp; leave tracking</div>
          </div>
        </div>

        <nav class="nav">
          <button class="nav-link active" data-target="dashboard">Overview</button>
          <button class="nav-link" data-target="attendance">Attendance</button>
          <button class="nav-link" data-target="leave">Leave &amp; Absence</button>
          <button class="nav-link" data-target="shifts">Shift Management</button>
          <button class="nav-link" data-target="reports">Reports</button>
        </nav>

        <div class="user-area">
          <div class="notif-wrapper" id="notif-wrapper">
            <button class="notif-btn" id="notif-btn">
              üîî
              <span class="notif-count hidden" id="notif-count">0</span>
            </button>
            <div class="notif-dropdown hidden" id="notif-dropdown">
              <h4 id="notif-title">Notifications</h4>
              <ul class="notif-list" id="notif-list">
                <!-- JS -->
              </ul>
            </div>
          </div>
          <div class="pill" id="user-role-pill">
            Role: <span id="user-role-label">Employee</span> ‚Ä¢ User: <span id="user-name-label">-</span>
          </div>
          <button id="logout-btn" class="btn-ghost">Log out</button>
        </div>
      </header>

      <main class="dash-main">
        <!-- OVERVIEW -->
        <section class="view" data-view-id="dashboard">
          <h2 class="view-title">Today at a glance</h2>
          <p class="view-subtitle">Quick snapshot of attendance, requests and workload.</p>

          <div class="grid grid-3">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Attendance</div>
                <span class="badge">Live</span>
              </div>
              <div class="metric" id="metric-attendance">0</div>
              <div class="muted">Total clock-ins recorded in this session.</div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Leave requests</div>
                <span class="badge">Session</span>
              </div>
              <div class="metric" id="metric-leave">0</div>
              <div class="muted">Submitted &amp; tracked in this session.</div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Shift actions</div>
                <span class="badge">Session</span>
              </div>
              <div class="metric" id="metric-shifts">0</div>
              <div class="muted">Trades / pickups / drops requested.</div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">How to use this dashboard</div>
            <div class="section-body">
              Use <strong>Attendance</strong> to clock in/out, <strong>Leave &amp; Absence</strong> to submit time-off,
              <strong>Shift Management</strong> to trade or pick up shifts, and <strong>Reports</strong> (HR) to view
              a quick summary. HR can approve or reject requests from the üîî notification bell.
            </div>
          </div>
        </section>

        <!-- ATTENDANCE -->
        <section class="view hidden" data-view-id="attendance">
          <h2 class="view-title">Attendance</h2>
          <p class="view-subtitle">
            Employees: clock in/out once per state. HR: view who arrived and left, with timestamps.
          </p>

          <div class="card">
            <div id="attendance-entry-block">
              <div class="section-title">Clock in / Clock out</div>
              <form id="attendance-form">
                <div class="form-row" style="margin-top: 6px;">
                  <div class="field" style="flex: 0 0 auto;">
                    <label class="field-label">
                      <input type="radio" name="attendance-action" value="in" checked /> Clock in
                    </label>
                  </div>
                  <div class="field" style="flex: 0 0 auto;">
                    <label class="field-label">
                      <input type="radio" name="attendance-action" value="out" /> Clock out
                    </label>
                  </div>
                  <button type="submit" class="btn-small">Submit</button>
                </div>
              </form>
            </div>


            <!-- QR ATTENDANCE SECTION -->
            <div class="section" id="qr-section" style="margin-top:10px;">
              <div class="section-title">QR code attendance</div>
              <div class="section-body">
                In production this would use the camera to scan the QR on each staff ID badge.
                For this prototype, type a staff username (for example <code>employee1</code>) and click
                <strong>Simulate scan</strong>, or click <strong>Use camera scanner</strong> to see where a real scanner
                would hook in.
              </div>
              <div class="form-row" style="margin-top:6px;">
                <div class="field">
                  <div class="field-label">Simulated QR value</div>
                  <input id="qr-sim-input" type="text" class="input" placeholder="e.g. employee1" />
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button type="button" id="qr-sim-btn" class="btn-small">Simulate scan</button>
                  <button type="button" id="qr-camera-btn" class="btn-small" style="margin-left:6px;">
                    Use camera scanner
                  </button>
                </div>
              </div>
              <div class="section-body" id="qr-scan-status" style="margin-top:4px; font-size:11px;">
                Waiting for scan‚Ä¶
              </div>
              <div class="section-body" id="qr-camera-container" style="margin-top:4px; font-size:11px;">
                Camera scanner not started. In production, this area would show the live video preview from the QR
                reader.
              </div>
            </div>
            <!-- END QR ATTENDANCE SECTION -->

            <!-- NEW: Work Hours Summary Table -->
            <div class="work-hours-section" style="margin-top: 40px;">
              <div class="section-title">Work Hours Summary</div>
              <p class="section-body" style="margin-bottom:10px;">Your recorded activity for the past 7 days.</p>

              <table id="workHoursTable">
                <thead>
                  <tr>
                    <th style="width: 30%">Clock In / Out Times</th>
                    <th style="width: 20%">Employee</th>
                    <th style="width: 15%">Duration</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div id="weeklyTotal" class="table-footer-total">
                TOTAL: <span class="total-highlight">0.00 Hours</span>
              </div>
            </div>


            <!---
            <table>
              <thead id="attendance-head">
              </thead>
              <tbody id="attendance-rows">
              </tbody>
            </table>
            -->

          </div>
        </section>

        <!-- LEAVE & ABSENCE -->
        <section class="view hidden" data-view-id="leave">
          <h2 class="view-title">Leave &amp; Absence</h2>
          <p class="view-subtitle">Submit leave/absence requests for HR approval.</p>

          <div class="card">
            <div id="leave-form-section">
              <div class="section-title">New leave request</div>
              <form id="leave-form">
                <div class="form-row" style="margin-top: 6px;">
                  <div class="field">
                    <div class="field-label">From</div>
                    <input id="leave-from" type="date" class="input" />
                  </div>
                  <div class="field">
                    <div class="field-label">To</div>
                    <input id="leave-to" type="date" class="input" />
                  </div>
                </div>
                <div class="field">
                  <div class="field-label">Reason</div>
                  <input id="leave-reason" type="text" class="input" placeholder="Vacation, sick, personal..." />
                </div>
                <button type="submit" class="btn-small">Submit leave request</button>
              </form>
            </div>

            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Employee</th>
                  <th>Period</th>
                  <th>Reason</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="leave-rows">
                <!-- JS -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- SHIFT MANAGEMENT -->
        <section class="view hidden" data-view-id="shifts">
          <h2 class="view-title">Shift Management</h2>
          <p class="view-subtitle">
            Employees: request trades or pickups. HR: assign hospital shifts and approve requests.
          </p>

          <div class="card">
            <div class="section-title">Shift overview</div>
            <div class="section-body">
              Review assigned shifts and available hospital coverage, then submit or approve requests.
            </div>

            <div class="grid grid-2" style="margin-top: 8px;">
              <div>
                <div class="section-title">My assigned shifts</div>
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Shift</th>
                    </tr>
                  </thead>
                  <tbody id="my-shift-rows">
                    <!-- JS -->
                  </tbody>
                </table>
              </div>
              <div>
                <div class="section-title">Available hospital shifts</div>
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Shift</th>
                    </tr>
                  </thead>
                  <tbody id="available-shift-rows">
                    <!-- JS -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- HR: create new shifts -->
            <div class="section hidden" id="hr-create-shift-section" style="margin-top:10px;">
              <div class="section-title">Create / assign hospital shifts</div>
              <form id="hr-shift-form">
                <div class="form-row" style="margin-top:6px;">
                  <div class="field">
                    <div class="field-label">Employee</div>
                    <select id="hr-shift-employee" class="input">
                      <!-- JS -->
                    </select>
                  </div>
                  <div class="field">
                    <div class="field-label">Shift description</div>
                    <input id="hr-shift-desc" type="text" class="input"
                      placeholder="e.g. Mon 07:00‚Äì15:00 ‚Äì ICU Nurse" />
                  </div>
                </div>
                <button type="submit" class="btn-small">Create shift</button>
              </form>
              <div class="section-body" style="margin-top:4px;">
                Shifts created here will appear under the selected employee‚Äôs assigned shifts.
              </div>
            </div>

            <!-- Employee: request shifts -->
            <div class="section" id="new-shift-request-section" style="margin-top:10px;">
              <div class="section-title">New shift request</div>
              <form id="shift-form">
                <div class="form-row" style="margin-top: 6px;">
                  <div class="field">
                    <div class="field-label">Action</div>
                    <select id="shift-action" class="input">
                      <option value="" selected>-- Select action --</option>
                      <option value="Trade">Trade shift</option>
                      <option value="Pick up">Pick up available shift</option>
                      <option value="Drop">Drop assigned shift</option>
                    </select>
                  </div>
                  <div class="field">
                    <div class="field-label">Select shift</div>
                    <select id="shift-select" class="input">
                      <!-- JS -->
                    </select>
                  </div>
                </div>
                <div class="field">
                  <div class="field-label">Notes (optional)</div>
                  <input id="shift-note" type="text" class="input"
                    placeholder="e.g. Trade with Dr. Brown, clinic run" />
                </div>
                <button type="submit" class="btn-small">Submit shift request</button>
              </form>
            </div>

            <div class="section" style="margin-top: 10px;">
              <div class="section-title" id="shift-requests-heading">Your shift requests (this session)</div>
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Employee</th>
                    <th>Type</th>
                    <th>Details</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="shift-rows">
                  <!-- JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REPORTS -->
        <section class="view hidden" data-view-id="reports">
          <h2 class="view-title">Summary &amp; Reports</h2>
          <p class="view-subtitle">
            High-level overview of attendance, leave and shifts for this session. Intended for HR/Admin.
          </p>

          <div class="grid grid-2">
            <div class="card">
              <div class="section-title">Session summary</div>
              <div class="section-body" id="report-summary" style="margin-top: 4px;">
                No data yet.
              </div>
              <div class="chips">
                <div class="chip" id="chip-attendance">Attendance: 0</div>
                <div class="chip" id="chip-leave">Leave: 0</div>
                <div class="chip" id="chip-shifts">Shifts: 0</div>
              </div>
            </div>

            <div class="card">
              <div class="section-title">Tips for HR</div>
              <div class="section-body">
                Use the <strong>üîî notification bell</strong> to approve or reject new requests. Once handled, status
                is updated in <strong>Leave &amp; Absence</strong> and <strong>Shift Management</strong>, and these
                numbers refresh here automatically.
              </div>
            </div>
          </div>

          <!-- Employee-specific report generator -->
          <div class="section" style="margin-top:10px;">
            <div class="card">
              <div class="section-title">Generate employee report</div>
              <form id="employee-report-form" style="margin-top:6px;">
                <div class="form-row">
                  <div class="field">
                    <div class="field-label">Select employee</div>
                    <select id="employee-report-select" class="input">
                      <!-- JS -->
                    </select>
                  </div>
                  <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                    <button type="submit" class="btn-small">Generate report</button>
                  </div>
                </div>
              </form>
              <div class="section-body" id="employee-report-output"
                style="margin-top:6px; padding-left: 20px; padding-right: 20px; max-width: 100%; overflow-x: auto;">
                Select an employee to view a summary of their attendance, leave and shift activity for this session.
              </div>
              <button type="button" id="employee-report-download" class="btn-small hidden">Download PDF</button>
            </div>
          </div>
        </section>
      </main>
    </section>
  </div>

  <script>
    (function () {
      const loginScreen = document.getElementById("login-screen");
      const dashboardScreen = document.getElementById("dashboard-screen");
      const loginForm = document.getElementById("login-form");
      const loginError = document.getElementById("login-error");
      const roleSelect = document.getElementById("role");
      const userRoleLabel = document.getElementById("user-role-label");
      const userNameLabel = document.getElementById("user-name-label");

      const loginShell = document.getElementById("login-shell");
      const toggleEmployee = document.getElementById("toggle-employee");
      const toggleHr = document.getElementById("toggle-hr");
      const loginMainHeading = document.getElementById("login-main-heading");
      const loginMainSub = document.getElementById("login-main-sub");
      const signInLabel = document.getElementById("sign-in-label");
      const loginHintEmployee = document.getElementById("login-hint-employee");
      const loginHintHr = document.getElementById("login-hint-hr");
      const leftCopyEmployee = document.getElementById("left-copy-employee");
      const leftCopyHr = document.getElementById("left-copy-hr");

      const navLinks = document.querySelectorAll(".nav-link");
      const views = document.querySelectorAll(".view");

      const logoutBtn = document.getElementById("logout-btn");

      // LOGOUT HANDLER
      logoutBtn.addEventListener("click", function () {
        // Clear user session data
        currentUser = null;
        currentRole = null;

        // Hide dashboard, show login
        dashboardScreen.classList.add("hidden");
        loginScreen.classList.remove("hidden");

        // Reset form + UI
        loginForm.reset();
        loginError.classList.add("hidden");

        // Reset role toggle to employee by default
        switchRole("employee");

        // Reset displayed user labels
        userRoleLabel.textContent = "Employee";
        userNameLabel.textContent = "-";
      });

      const notifWrapper = document.getElementById("notif-wrapper");
      const notifBtn = document.getElementById("notif-btn");
      const notifCount = document.getElementById("notif-count");
      const notifDropdown = document.getElementById("notif-dropdown");
      const notifList = document.getElementById("notif-list");
      const notifTitle = document.getElementById("notif-title");

      const togglePasswordBtn = document.getElementById("toggle-password");
      const passwordInput = document.getElementById("password");

      // Metrics + report chips
      const metricAttendance = document.getElementById("metric-attendance");
      const metricLeave = document.getElementById("metric-leave");
      const metricShifts = document.getElementById("metric-shifts");
      const reportSummary = document.getElementById("report-summary");
      const chipAttendance = document.getElementById("chip-attendance");
      const chipLeave = document.getElementById("chip-leave");
      const chipShifts = document.getElementById("chip-shifts");



      // Attendance
      const attendanceEntryBlock = document.getElementById("attendance-entry-block");
      const attendanceForm = document.getElementById("attendance-form");
      const attendanceHead = document.getElementById("attendance-head");
      const attendanceRows = document.getElementById("attendance-rows");
      const attendanceLog = [];

      // Load attendance logs for current user / role
      async function loadAttendanceForCurrentUser() {
        attendanceLog.length = 0;

        if (!currentUser || !currentRole) {
          renderAttendance();
          return;
        }

        try {
          let url;

          if (currentRole === "employee") {
            if (!currentUser.dbId) {
              console.warn("No dbId on currentUser; cannot load attendance");
              renderAttendance();
              return;
            }
            url = `/api/attendance/user/${currentUser.dbId}`;
          } else if (currentRole === "hr") {
            url = "/api/attendance/recent";
          } else {
            renderAttendance();
            return;
          }

          const res = await fetch(url);
          if (!res.ok) {
            throw new Error("Failed to fetch attendance");
          }

          const data = await res.json();
          const logs = data.logs || [];

          console.log("Loaded attendance logs:", logs); // ‚úÖ Debug

          logs.forEach((log) => {
            if (currentRole === "employee") {
              attendanceLog.push({
                userId: currentUser.dbId,
                user: currentUser.username,
                displayName: currentUser.displayName,
                type: log.event_type && log.event_type.toUpperCase() === "OUT" ? "out" : "in",
                time: log.recorded_at || new Date().toISOString(),
                hoursWorked: log.hoursWorked || null
              });
            } else {
              const fullName = [log.first_name, log.last_name].filter(Boolean).join(" ");

              attendanceLog.push({
                userId: log.user_id,
                user: log.user_id,
                displayName: fullName || `User #${log.user_id}`,
                type: log.event_type && log.event_type.toUpperCase() === "OUT" ? "out" : "in",
                time: log.recorded_at || new Date().toISOString(),
                hoursWorked: log.hoursWorked || null
              });
            }
          });

          console.log("attendanceLog after loading:", attendanceLog); // ‚úÖ Debug


          // ‚úÖ Set initial clocked-in state based on last event for current employee
          if (currentRole === "employee" && currentUser) {
            const userLogs = attendanceLog.filter(e => e.userId === currentUser.dbId);
            if (userLogs.length > 0) {
              // Sort by time to get most recent
              const sorted = userLogs.sort((a, b) => new Date(b.time) - new Date(a.time));
              const lastEvent = sorted[0];

              const status = getEmployeeStatus(currentUser.username);
              status.clockedIn = lastEvent.type === "in";

              console.log("Initial clock state:", status.clockedIn ? "CLOCKED IN" : "CLOCKED OUT");
            }
          }

          renderAttendance();
          renderWorkHoursTable();
          updateAttendanceControls();
        } catch (err) {
          console.error("Failed to load attendance:", err);
          renderAttendance();
          renderWorkHoursTable();
        }
      }

      // Save attendance to server
      async function saveAttendanceToServer({ userDbId, eventType, source = "WEB_FORM", qrValue = null }) {
        const res = await fetch("/api/attendance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: userDbId,      // numeric users.id
            action: eventType,     // "in" or "out"
            source: source,
            qrValue: qrValue
          })
        });

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.message || "Failed to save attendance");
        }

        const data = await res.json(); // { log: { ... } }
        return data.log;
      }



      // QR attendance elements
      const qrSimInput = document.getElementById("qr-sim-input");
      const qrSimBtn = document.getElementById("qr-sim-btn");
      const qrCameraBtn = document.getElementById("qr-camera-btn");
      const qrScanStatus = document.getElementById("qr-scan-status");
      const qrCameraContainer = document.getElementById("qr-camera-container");


      // Leave section

      const leaveFormSection = document.getElementById("leave-form-section");
      const leaveForm = document.getElementById("leave-form");
      const leaveRows = document.getElementById("leave-rows");
      const leaveRequests = [];

      // Load leave requests for current user / role
      async function loadLeaveForCurrentUser() {
        // Clear current in-memory list
        leaveRequests.length = 0;

        if (!currentUser || !currentRole) {
          renderLeave();
          return;
        }

        try {
          let url;

          if (currentRole === "employee") {
            // Employee: only see their own leave
            if (!currentUser.dbId) {
              console.warn("No dbId on currentUser; cannot load leave");
              renderLeave();
              return;
            }
            url = `/api/leave/user/${currentUser.dbId}`;
          } else if (currentRole === "hr") {
            // HR: see all leave requests
            url = "/api/leave";
          } else {
            renderLeave();
            return;
          }

          const res = await fetch(url);
          if (!res.ok) {
            throw new Error("Failed to fetch leave requests");
          }

          const data = await res.json();
          const leaves = data.leaves || [];

          leaves.forEach((lv) => {
            // DB status is PENDING / APPROVED / REJECTED
            const rawStatus = (lv.status || "PENDING").toUpperCase();
            let baseStatus;

            if (rawStatus === "APPROVED") baseStatus = "Approved";
            else if (rawStatus === "REJECTED") baseStatus = "Rejected";
            else baseStatus = "Pending";

            const base = {
              id: lv.id,
              userId: lv.user_id,
              from: lv.from_date,         // raw date string from DB
              to: lv.to_date,             // raw date string from DB
              reason: lv.reason,
              status: baseStatus,         // "Pending" | "Approved" | "Rejected"
              submittedAt: lv.submitted_at || null,
            };

            if (currentRole === "employee") {
              // For employees, we know their name from login
              base.displayName = currentUser.displayName;
              base.username = currentUser.username;
            } else if (currentRole === "hr") {
              // For HR, use name from backend join on users:
              // employee_first_name / employee_last_name
              const fullName = [
                lv.employee_first_name,
                lv.employee_last_name
              ].filter(Boolean).join(" ");

              base.displayName = fullName || `User #${lv.user_id}`;
              // staff id 
              base.username = lv.employee_staff_id || null;
            }

            leaveRequests.push(base);
          });

          renderLeave();
        } catch (err) {
          console.error("Failed to load leave requests:", err);
          renderLeave(); // render empty state at least
        }
      }

      // Shifts ‚Äì tables + forms. section

      const myShiftRows = document.getElementById("my-shift-rows");
      const availableShiftRows = document.getElementById("available-shift-rows");
      const shiftForm = document.getElementById("shift-form");
      const shiftRows = document.getElementById("shift-rows");
      const shiftActionSelect = document.getElementById("shift-action");
      const shiftSelect = document.getElementById("shift-select");
      const shiftNote = document.getElementById("shift-note");
      const newShiftRequestSection = document.getElementById("new-shift-request-section");
      const shiftRequestsHeading = document.getElementById("shift-requests-heading");
      const shiftRequests = [];


      const assignedShifts = [];   // shifts assigned to current user (from /api/shifts/user/:id)
      const availableShifts = [];  // shifts with status = 'AVAILABLE' (from /api/shifts/available)
      const hrEmployees = [];



      function renderShifts() {
        if (!shiftRows || !Array.isArray(shiftRequests)) return;
        shiftRows.innerHTML = "";

        const rows = shiftRequests;

        rows.forEach((req, index) => {
          const tr = document.createElement("tr");
          const tdIndex = document.createElement("td");
          const tdEmployee = document.createElement("td");
          const tdType = document.createElement("td");
          const tdDetails = document.createElement("td");
          const tdStatus = document.createElement("td");

          tdIndex.textContent = (index + 1).toString();

          // Show employee name
          const empName =
            req.userDisplayName ||
            (req.userId ? `User #${req.userId}` : req.user || "-");
          tdEmployee.textContent = empName;

          // Show request type
          tdType.textContent = req.type; // "Trade" | "Pick up" | "Drop"

          // Show shift label + optional note
          let detailsText = req.shiftLabel || `Shift #${req.shiftId}`;

          if (req.shiftDescription) {
            detailsText = req.shiftDescription;
          }

          if (req.note) {
            detailsText += " ‚Äì " + req.note;
          }
          tdDetails.textContent = detailsText;

          // Status pill
          const statusInfo = formatStatus(req.status); // "Pending" | "Approved" | "Rejected"
          const statusPill = document.createElement("span");
          statusPill.classList.add("pill-status");
          if (statusInfo.cls) statusPill.classList.add(statusInfo.cls);
          statusPill.textContent = statusInfo.label;

          if (currentRole === "hr") {
            // HR sees inline actions for shift requests
            const wrapper = document.createElement("div");
            wrapper.classList.add("leave-actions-wrapper");
            wrapper.addEventListener("click", function (evt) {
              evt.stopPropagation();
            });

            wrapper.appendChild(statusPill);

            const toggleBtn = document.createElement("button");
            toggleBtn.type = "button";
            toggleBtn.classList.add("leave-action-toggle");
            toggleBtn.textContent = "‚ãØ";

            const menu = document.createElement("div");
            menu.classList.add("leave-action-menu", "hidden");

            const approveBtn = document.createElement("button");
            approveBtn.textContent = "Approve";
            approveBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              menu.classList.add("hidden");
              handleShiftAction(index, "APPROVED");
            });

            const rejectBtn = document.createElement("button");
            rejectBtn.classList.add("leave-action-reject");
            rejectBtn.textContent = "Reject";
            rejectBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              menu.classList.add("hidden");
              handleShiftAction(index, "REJECTED");
            });

            const resetBtn = document.createElement("button");
            resetBtn.textContent = "Reset to pending";
            resetBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              menu.classList.add("hidden");
              handleShiftAction(index, "PENDING");
            });

            menu.appendChild(approveBtn);
            menu.appendChild(rejectBtn);
            menu.appendChild(resetBtn);

            toggleBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              const isHidden = menu.classList.contains("hidden");
              const menus = document.querySelectorAll(".leave-action-menu");
              menus.forEach((m) => m.classList.add("hidden"));
              if (isHidden) {
                menu.classList.remove("hidden");
              }
            });

            wrapper.appendChild(toggleBtn);
            wrapper.appendChild(menu);

            tdStatus.appendChild(wrapper);
          } else {
            // Employee view: just show the pill
            tdStatus.appendChild(statusPill);
          }

          tr.appendChild(tdIndex);
          tr.appendChild(tdEmployee);
          tr.appendChild(tdType);
          tr.appendChild(tdDetails);
          tr.appendChild(tdStatus);

          shiftRows.appendChild(tr);
        });

        updateMetrics();
        updateReports();
      }

      async function handleShiftAction(index, newStatus) {
        const req = shiftRequests[index];
        if (!req) return;
        if (!currentUser || currentRole !== "hr") return;

        const requestId = req.id;
        if (!requestId) {
          console.error("Missing shift request id:", req);
          return;
        }

        try {
          const res = await fetch(`/api/shift-requests/${requestId}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              status: newStatus,
              approverId: currentUser.dbId
            })
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.message || "Failed to update shift request status");
          }

          const data = await res.json();
          const updated = data.shiftRequest || {};

          // Normalise status
          const rawStatus = (updated.status || newStatus || "PENDING").toUpperCase();
          let baseStatus;
          if (rawStatus === "APPROVED") baseStatus = "Approved";
          else if (rawStatus === "REJECTED") baseStatus = "Rejected";
          else baseStatus = "Pending";

          req.status = baseStatus;
          req.approvedBy = updated.approved_by || null;
          req.approvedAt = updated.approved_at || null;

          // Notify employee
          if (req.user) {
            addNotification({
              text:
                "Your " +
                req.type.toLowerCase() +
                " request for " +
                req.shiftLabel +
                " was " +
                baseStatus,
              kind: "shift",
              indexRef: index,
              targetRole: "employee",
              targetUser: req.user
            });
          }

          // Refresh data after approval/rejection
          await loadShiftsForCurrentUser();
          await loadShiftRequestsForCurrentUser();

          renderShifts();
          renderShiftPools();
          renderNotifications();
        } catch (err) {
          console.error("handleShiftAction error:", err);
          alert("Could not update shift request status. Please try again.");
        }
      }

      // Load shifts (assigned + available) for current user / role

      async function loadShiftsForCurrentUser() {
        // clear current data
        assignedShifts.length = 0;
        availableShifts.length = 0;

        if (!currentUser || !currentRole) {
          renderShiftPools();
          renderShifts();
          return;
        }

        try {
          // Employee's own assigned shifts
          if (currentRole === "employee" && currentUser.dbId) {
            const resAssigned = await fetch(`/api/shifts/user/${currentUser.dbId}`);
            if (!resAssigned.ok) {
              throw new Error("Failed to fetch user shifts");
            }
            const dataAssigned = await resAssigned.json();
            const shifts = dataAssigned.shifts || [];

            shifts.forEach((s) => {
              assignedShifts.push({
                id: s.id,
                label: s.description || `Shift #${s.id}`,
                status: s.status,
              });
            });
          }

          // Available shifts ‚Äì pass userId so employee doesn't see their own assigned shifts
          const availUrl = currentRole === "employee" && currentUser.dbId
            ? `/api/shifts/available?userId=${currentUser.dbId}`
            : "/api/shifts/available";

          const resAvail = await fetch(availUrl);
          if (!resAvail.ok) {
            throw new Error("Failed to fetch available shifts");
          }
          const dataAvail = await resAvail.json();
          const avail = dataAvail.shifts || [];

          // Check for pending TRADE requests by current user to mark trades
          let pendingTradeShiftIds = [];
          if (currentRole === "employee" && currentUser.dbId) {
            const resTradeRequests = await fetch(`/api/shift-requests/user/${currentUser.dbId}`);
            if (resTradeRequests.ok) {
              const tradeData = await resTradeRequests.json();
              const requests = tradeData.shiftRequests || [];
              pendingTradeShiftIds = requests
                .filter(r => r.request_type === "TRADE" && r.status === "PENDING")
                .map(r => r.shift_id);
            }
          }

          avail.forEach((s) => {
            availableShifts.push({
              id: s.id,
              label: s.description || `Shift #${s.id}`,
              status: s.status,
              isTrade: pendingTradeShiftIds.includes(s.id),
            });
          });

          renderShiftPools();
          populateShiftOptions();
          renderShifts();
        } catch (err) {
          console.error("Failed to load shifts:", err);
          renderShiftPools();
          renderShifts();
        }
      }

      // Load shift requests for current user / role

      async function loadShiftRequestsForCurrentUser() {
        // Clear in-memory list
        shiftRequests.length = 0;

        if (!currentUser || !currentRole) {
          renderShifts();
          updateReports();
          return;
        }

        try {
          let url;

          if (currentRole === "employee") {
            if (!currentUser.dbId) {
              console.warn("No dbId on currentUser; cannot load shift requests");
              renderShifts();
              updateReports();
              return;
            }
            url = `/api/shift-requests/user/${currentUser.dbId}`;
          } else if (currentRole === "hr") {
            url = "/api/shift-requests";
          } else {
            renderShifts();
            updateReports();
            return;
          }

          const res = await fetch(url);
          if (!res.ok) {
            throw new Error("Failed to fetch shift requests");
          }

          const data = await res.json();
          const rows = data.shiftRequests || [];

          rows.forEach((sr) => {
            const rawStatus = (sr.status || "PENDING").toUpperCase();
            let baseStatus = "Pending";
            if (rawStatus === "APPROVED") baseStatus = "Approved";
            else if (rawStatus === "REJECTED") baseStatus = "Rejected";

            const typeRaw = (sr.request_type || "TRADE").toUpperCase();
            const typeLabel =
              typeRaw === "PICK_UP" ? "Pick up" :
                typeRaw === "DROP" ? "Drop" : "Trade";

            const base = {
              id: sr.id,
              userId: sr.user_id,
              shiftId: sr.shift_id,
              type: typeLabel,
              note: sr.note || null,
              status: baseStatus, // "Pending" | "Approved" | "Rejected"
              source: sr.source || null,
              createdAt: sr.created_at || null,
              approvedBy: sr.approved_by || null,
              approvedAt: sr.approved_at || null,
              shiftDescription: sr.shift_description || null,
            };

            // Enrich display for HR
            if (currentRole === "hr") {
              const fullName = [sr.employee_first_name, sr.employee_last_name].filter(Boolean).join(" ");
              base.userDisplayName = fullName || `User #${sr.user_id}`;
              base.username = sr.employee_staff_id || null;
              base.shiftLabel = sr.shift_description ? sr.shift_description : `Shift #${sr.shift_id}`;
            } else {
              base.userDisplayName = currentUser.displayName;
              base.username = currentUser.username;
              base.shiftLabel = sr.shift_description || `Shift #${sr.shift_id}`;
            }

            shiftRequests.push(base);
          });

          // After loading, we will re-render tables and update badges in renderShiftPools
          renderShifts();
          updateReports();
        } catch (err) {
          console.error("Failed to load shift requests:", err);
          renderShifts();
          updateReports();
        }
      }




      // HR shift creation

      const hrCreateShiftSection = document.getElementById("hr-create-shift-section");
      const hrShiftForm = document.getElementById("hr-shift-form");
      const hrShiftEmployee = document.getElementById("hr-shift-employee");
      const hrShiftDesc = document.getElementById("hr-shift-desc");

      // Employee report

      const employeeReportForm = document.getElementById("employee-report-form");
      const employeeReportSelect = document.getElementById("employee-report-select");
      const employeeReportOutput = document.getElementById("employee-report-output");

      const downloadReportBtn = document.getElementById("employee-report-download");
      if (downloadReportBtn) downloadReportBtn.classList.add("hidden");

      // Per-employee clocked-in status

      const employeeStatus = {}; // { username: { clockedIn: bool } }

      function getEmployeeStatus(username) {
        if (!employeeStatus[username]) {
          employeeStatus[username] = { clockedIn: false };
        }
        return employeeStatus[username];
      }

      // Update attendance IN/OUT radio buttons based on current status
      function updateAttendanceControls() {
        const inRadio = document.querySelector('input[name="attendance-action"][value="in"]');
        const outRadio = document.querySelector('input[name="attendance-action"][value="out"]');
        if (!inRadio || !outRadio) return;

        if (!currentUser || currentRole !== "employee") {
          // Not logged in as employee - disable both
          inRadio.disabled = true;
          outRadio.disabled = true;
          inRadio.checked = false;
          outRadio.checked = false;
          return;
        }

        const status = getEmployeeStatus(currentUser.username);

        if (status.clockedIn) {
          // Currently clocked IN - only allow clock OUT
          inRadio.disabled = true;
          outRadio.disabled = false;
          inRadio.checked = false;
          outRadio.checked = true;
        } else {
          // Currently clocked OUT - only allow clock IN
          inRadio.disabled = false;
          outRadio.disabled = true;
          inRadio.checked = true;
          outRadio.checked = false;
        }
      }
      // Notifications: { text, kind, indexRef, handled, targetRole, targetUser, seen }
      const notifications = [];

      let currentRole = null; // "employee" or "hr"
      let currentUser = null; // { role, username, displayName }

      function switchRole(role) {
        roleSelect.value = role;
        loginShell.dataset.role = role;

        if (role === "employee") {
          toggleEmployee.classList.add("active");
          toggleHr.classList.remove("active");
          loginMainHeading.textContent = "Employee sign in";
          loginMainSub.textContent =
            "Use your staff ID and password to access your attendance and shift information.";
          signInLabel.textContent = "Sign in as Employee";
          loginHintEmployee.classList.remove("hidden");
          loginHintHr.classList.add("hidden");
          leftCopyEmployee.classList.remove("hidden");
          leftCopyHr.classList.add("hidden");
        } else {
          toggleHr.classList.add("active");
          toggleEmployee.classList.remove("active");
          loginMainHeading.textContent = "HR / Manager sign in";
          loginMainSub.textContent =
            "Access attendance exceptions, approve leave and publish official schedules.";
          signInLabel.textContent = "Sign in as HR / Manager";
          loginHintEmployee.classList.add("hidden");
          loginHintHr.classList.remove("hidden");
          leftCopyEmployee.classList.add("hidden");
          leftCopyHr.classList.remove("hidden");
        }
      }

      toggleEmployee.addEventListener("click", function (e) {
        e.preventDefault();
        switchRole("employee");
      });

      toggleHr.addEventListener("click", function (e) {
        e.preventDefault();
        switchRole("hr");
      });

      // Password eye toggle
      togglePasswordBtn.addEventListener("click", function () {
        const isPwd = passwordInput.type === "password";
        passwordInput.type = isPwd ? "text" : "password";
        togglePasswordBtn.textContent = isPwd ? "üôà" : "üëÅ";
        togglePasswordBtn.setAttribute("aria-label", isPwd ? "Hide password" : "Show password");
      });

      // Navigation handler
      function showView(viewName) {
        // Switch visible section
        views.forEach((v) => v.classList.add("hidden"));
        const target = document.querySelector('[data-view-id="' + viewName + '"]');
        if (target) target.classList.remove("hidden");

        // Update active nav pill
        navLinks.forEach((link) => {
          if (link.dataset.target === viewName) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });

        // Ensure data is loaded from the backend for each view
        if (!currentUser || !currentRole) return;

        if (viewName === "attendance") {
          // Reload attendance from DB
          loadAttendanceForCurrentUser();
        } else if (viewName === "leave") {
          // Reload leave from DB
          loadLeaveForCurrentUser();
        } else if (viewName === "shifts") {
          // Reload shifts + shift requests from DB
          loadShiftsForCurrentUser();
          loadShiftRequestsForCurrentUser();
        } else if (viewName === "reports") {
          if (downloadReportBtn) downloadReportBtn.classList.add("hidden");
          // For reports, make sure *all* DB-backed data is fresh
          Promise.all([
            loadAttendanceForCurrentUser(),
            loadLeaveForCurrentUser(),
            loadShiftsForCurrentUser(),
            loadShiftRequestsForCurrentUser(),
          ])
            .then(() => {
              // Now recompute counts using DB data
              updateMetrics();
              updateReports();
            })
            .catch((err) => {
              console.error("Failed to refresh data for reports:", err);
              // Still try to update with whatever we have
              updateMetrics();
              updateReports();
            });
        }
      }
      function getMyShifts() {
        if (!currentUser || currentRole !== "employee") return [];
        return assignedShifts;
      }

      function getCounts() {
        if (!currentUser || currentRole === "hr") {
          return {
            attendance: attendanceLog.length,
            leave: leaveRequests.length,
            shifts: shiftRequests.length
          };
        }
        const u = currentUser.username;
        return {
          attendance: attendanceLog.filter((e) => e.user === u).length,
          leave: leaveRequests.filter((e) => e.user === u).length,
          shifts: shiftRequests.filter((e) => e.user === u).length
        };
      }

      function updateMetrics() {
        const c = getCounts();
        metricAttendance.textContent = c.attendance.toString();
        metricLeave.textContent = c.leave.toString();
        metricShifts.textContent = c.shifts.toString();
      }

      function updateReports() {
        const a = attendanceLog.length;
        const l = leaveRequests.length;
        const s = shiftRequests.length;

        reportSummary.textContent =
          "Total attendance records: " +
          a +
          " | Leave requests: " +
          l +
          " | Shift requests: " +
          s +
          " (session only).";

        chipAttendance.textContent = "Attendance: " + a;
        chipLeave.textContent = "Leave: " + l;
        chipShifts.textContent = "Shifts: " + s;
      }

      // Status mapping for Employee vs HR
      function formatStatus(baseStatus) {
        let label = baseStatus;
        if (currentRole === "employee") {
          if (baseStatus === "Pending") label = "Submitted";
          else if (baseStatus === "Rejected") label = "Denied";
        }
        let cls = "";
        if (baseStatus === "Pending") cls = "status-pending";
        else if (baseStatus === "Approved") cls = "status-approved";
        else if (baseStatus === "Rejected") cls = "status-rejected";
        return { label, cls };
      }


      // Render functions for tables
      // Replace the entire renderAttendance function (around line 1448):
      function renderAttendance() {
        // Only render old table if elements exist
        if (attendanceHead && attendanceRows) {
          attendanceHead.innerHTML = "";
          attendanceRows.innerHTML = "";

          const headRow = document.createElement("tr");
          const thIndex = document.createElement("th");
          thIndex.textContent = "#";
          headRow.appendChild(thIndex);

          if (currentRole === "hr") {
            const thEmp = document.createElement("th");
            thEmp.textContent = "Employee";
            headRow.appendChild(thEmp);
          }

          const thAction = document.createElement("th");
          thAction.textContent = "Action";
          const thTime = document.createElement("th");
          thTime.textContent = "Time";
          const thHours = document.createElement("th");
          thHours.textContent = "Hours Worked";

          headRow.appendChild(thAction);
          headRow.appendChild(thTime);
          headRow.appendChild(thHours);
          attendanceHead.appendChild(headRow);

          const rows =
            currentRole === "employee" && currentUser
              ? attendanceLog.filter((entry) => entry.user === currentUser.username)
              : attendanceLog;

          rows.forEach((entry, index) => {
            const tr = document.createElement("tr");
            const tdIndex = document.createElement("td");
            tdIndex.textContent = (index + 1).toString();
            tr.appendChild(tdIndex);

            if (currentRole === "hr") {
              const tdEmp = document.createElement("td");
              tdEmp.textContent = entry.displayName || `User #${entry.userId}` || (entry.user || "-");
              tr.appendChild(tdEmp);
            }
            const tdAction = document.createElement("td");
            const tdTime = document.createElement("td");
            const tdHours = document.createElement("td");

            tdAction.textContent = entry.type === "in" ? "Clock in" : "Clock out";
            tdTime.textContent = entry.time;

            if (entry.type === "out" && entry.hoursWorked != null) {
              tdHours.textContent = entry.hoursWorked.toFixed(2) + " hrs";
            } else {
              tdHours.textContent = "-";
            }

            tr.appendChild(tdAction);
            tr.appendChild(tdTime);
            tr.appendChild(tdHours);
            attendanceRows.appendChild(tr);
          });
        }

        updateMetrics();
        updateReports();
        renderWorkHoursTable();
      }

      // ,......Add this function after the renderAttendance() function (around line 1350)

      function renderWorkHoursTable() {
        const tbody = document.querySelector('#workHoursTable tbody');
        const weeklyTotalEl = document.getElementById('weeklyTotal');
        const sectionTitle = document.querySelector('.work-hours-section .section-title');
        const sectionBody = document.querySelector('.work-hours-section .section-body');

        if (!tbody) return;

        tbody.innerHTML = '';

        // Update title and description based on role
        if (sectionTitle) {
          sectionTitle.textContent = currentRole === 'hr' ? 'All Employee Work Hours' : 'Work Hours Summary';
        }
        if (sectionBody) {
          sectionBody.textContent = currentRole === 'hr'
            ? 'Complete work hours for all employees.'
            : 'Your recorded activity for the past 7 days.';
        }

        if (!currentUser) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 3;
          td.textContent = 'Please log in to see work hours.';
          td.style.textAlign = 'center';
          td.style.color = 'var(--text-muted)';
          tr.appendChild(td);
          tbody.appendChild(tr);
          if (weeklyTotalEl) weeklyTotalEl.innerHTML = 'TOTAL: <span class="total-highlight">0.00 Hours</span>';
          return;
        }

        // Filter attendance based on role
        let filteredAttendance;
        if (currentRole === 'hr') {
          // HR: show all employees, all time
          filteredAttendance = attendanceLog;
        } else {
          // Employee: show only their own data
          filteredAttendance = attendanceLog.filter(e => e.userId === currentUser.dbId);
        }

        const userAttendance = filteredAttendance
          .map(e => {
            const dt = new Date(e.time);
            return { ...e, _dt: dt };
          })
          .filter(e => !isNaN(e._dt.getTime()))
          .sort((a, b) => a._dt - b._dt); // Sort chronologically

        if (userAttendance.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 3;
          td.textContent = 'No attendance records found.';
          td.style.textAlign = 'center';
          td.style.color = 'var(--text-muted)';
          tr.appendChild(td);
          tbody.appendChild(tr);
          if (weeklyTotalEl) weeklyTotalEl.innerHTML = 'TOTAL: <span class="total-highlight">0.00 Hours</span>';
          return;
        }

        console.log('User attendance (sorted):', userAttendance);

        // Group by user if HR, otherwise just process as one user
        const byUser = new Map();

        userAttendance.forEach(entry => {
          const userKey = currentRole === 'hr' ? entry.userId : currentUser.dbId;
          if (!byUser.has(userKey)) {
            byUser.set(userKey, {
              userId: entry.userId,
              displayName: entry.displayName || `User #${entry.userId}`,
              events: []
            });
          }
          byUser.get(userKey).events.push(entry);
        });

        console.log('Grouped by user:', byUser);

        let totalMinutesAllUsers = 0;
        const allSessions = [];

        // Process each user's events
        byUser.forEach((userData, userKey) => {
          const events = userData.events;

          // Pair IN/OUT events chronologically for this user
          let currentIn = null;

          events.forEach(entry => {
            if (entry.type === 'in') {
              currentIn = entry;
            } else if (entry.type === 'out' && currentIn) {
              // Complete session
              allSessions.push({
                userId: userData.userId,
                displayName: userData.displayName,
                inEvent: currentIn,
                outEvent: entry,
                date: currentIn._dt
              });
              currentIn = null;
            }
          });

          // If there's an unpaired IN, add it as in-progress
          if (currentIn) {
            allSessions.push({
              userId: userData.userId,
              displayName: userData.displayName,
              inEvent: currentIn,
              outEvent: null,
              date: currentIn._dt
            });
          }
        });

        console.log('All sessions:', allSessions);

        // Sort sessions by date descending (most recent first)
        allSessions.sort((a, b) => b.date - a.date);

        allSessions.forEach(session => {
          const tr = document.createElement('tr');

          // Clock In / Out Times column
          const tdTimes = document.createElement('td');
          const stackDiv = document.createElement('div');
          stackDiv.classList.add('time-stack');

          const dateDiv = document.createElement('div');
          dateDiv.classList.add('time-date');
          dateDiv.textContent = session.date.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });
          stackDiv.appendChild(dateDiv);

          // IN time
          const inDiv = document.createElement('div');
          inDiv.classList.add('time-entry');
          inDiv.innerHTML = `<span>IN</span>${session.inEvent._dt.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          })}`;
          stackDiv.appendChild(inDiv);

          // OUT time (if exists)
          if (session.outEvent) {
            const outDiv = document.createElement('div');
            outDiv.classList.add('time-entry');
            outDiv.innerHTML = `<span>OUT</span>${session.outEvent._dt.toLocaleTimeString('en-US', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            })}`;
            stackDiv.appendChild(outDiv);
          }

          tdTimes.appendChild(stackDiv);
          tr.appendChild(tdTimes);

          // Employee column - show employee name (important for HR view)
          const tdEmployee = document.createElement('td');
          tdEmployee.textContent = session.displayName;
          tr.appendChild(tdEmployee);

          // Duration column
          const tdDuration = document.createElement('td');

          if (session.outEvent) {
            // Completed session
            const durationMs = session.outEvent._dt - session.inEvent._dt;

            if (durationMs > 0) {
              const hours = (durationMs / (1000 * 60 * 60)).toFixed(2);
              const minutes = Math.round(durationMs / (1000 * 60));
              totalMinutesAllUsers += minutes;

              tdDuration.innerHTML = `<div class="duration-main">${hours} hrs</div><div class="duration-sub status-text-complete">Completed</div>`;
            } else {
              // Negative duration (data issue)
              tdDuration.innerHTML = `<div class="duration-incomplete">0.00 hrs</div><div class="duration-sub status-text-progress" style="color: #f97316;">Data Error</div>`;
            }
          } else {
            // In progress (no OUT yet)
            tdDuration.innerHTML = `<div class="duration-incomplete">‚Äî</div><div class="duration-sub status-text-progress">In Progress</div>`;
          }

          tr.appendChild(tdDuration);
          tbody.appendChild(tr);
        });

        // Update total label based on role
        if (weeklyTotalEl) {
          const totalHours = (totalMinutesAllUsers / 60).toFixed(2);
          const totalLabel = currentRole === 'hr' ? 'TOTAL (All Employees)' : 'TOTAL';
          weeklyTotalEl.innerHTML = `${totalLabel}: <span class="total-highlight">${totalHours} Hours</span>`;
        }
      }
      // Add this function after the notifications array declaration (around line 1200)

      function addNotification({ text, kind, indexRef, targetRole, targetUser }) {
        notifications.push({
          text: text,
          kind: kind,           // "leave" | "shift" | "attendance"
          indexRef: indexRef,   // reference to the request index
          handled: false,
          targetRole: targetRole,   // "employee" | "hr"
          targetUser: targetUser,   // specific username if targeting employee
          seen: false
        });
        renderNotifications();
      }

      function renderNotifications() {
        notifList.innerHTML = "";

        // Filter notifications based on role
        const filtered = notifications.filter((n) => {
          if (!n.targetRole) return true;  // show to all

          if (currentRole === "hr" && n.targetRole === "hr") {
            return !n.handled;  // HR only sees unhandled
          }

          if (currentRole === "employee" && n.targetRole === "employee") {
            if (n.targetUser && currentUser && n.targetUser !== currentUser.username) {
              return false;  // not for this employee
            }
            return true;  // show to this employee
          }

          return false;
        });

        const count = filtered.length;

        if (count === 0) {
          notifCount.classList.add("hidden");
          notifTitle.textContent = "Notifications";
          const li = document.createElement("li");
          li.textContent = "No new notifications.";
          li.style.color = "var(--text-muted)";
          notifList.appendChild(li);
          return;
        }

        notifCount.textContent = count.toString();
        notifCount.classList.remove("hidden");

        const unseenCount = filtered.filter(n => !n.seen).length;
        if (unseenCount > 0) {
          notifTitle.textContent = `Notifications (${unseenCount} new)`;
        } else {
          notifTitle.textContent = "Notifications";
        }

        filtered.forEach((notif, i) => {
          const li = document.createElement("li");
          li.style.opacity = notif.seen ? "0.6" : "1";

          const textDiv = document.createElement("div");
          textDiv.textContent = notif.text;
          li.appendChild(textDiv);

          // HR can approve/reject from the bell
          if (currentRole === "hr" && !notif.handled) {
            const actions = document.createElement("div");
            actions.classList.add("notif-actions");

            const approveBtn = document.createElement("button");
            approveBtn.classList.add("notif-approve");
            approveBtn.textContent = "Approve";
            approveBtn.addEventListener("click", async function () {
              notif.handled = true;

              if (notif.kind === "leave") {
                await handleLeaveAction(notif.indexRef, "APPROVED");
              } else if (notif.kind === "shift") {
                await handleShiftAction(notif.indexRef, "APPROVED");
              }

              renderNotifications();
            });

            const rejectBtn = document.createElement("button");
            rejectBtn.classList.add("notif-reject");
            rejectBtn.textContent = "Reject";
            rejectBtn.addEventListener("click", async function () {
              notif.handled = true;

              if (notif.kind === "leave") {
                await handleLeaveAction(notif.indexRef, "REJECTED");
              } else if (notif.kind === "shift") {
                await handleShiftAction(notif.indexRef, "REJECTED");
              }

              renderNotifications();
            });

            actions.appendChild(approveBtn);
            actions.appendChild(rejectBtn);
            li.appendChild(actions);
          }

          notifList.appendChild(li);
        });
      }

      // HR-only: update leave status via API and refresh UI

      async function handleLeaveAction(index, newStatus) {
        const req = leaveRequests[index];
        if (!req) return;
        if (!currentUser || currentRole !== "hr") return;

        const leaveId = req.id;
        if (!leaveId) {
          console.error("Missing leave id on request:", req);
          return;
        }

        try {
          const res = await fetch(`/api/leave/${leaveId}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              status: newStatus,          // "APPROVED" or "REJECTED" or "PENDING"
              approverId: currentUser.dbId
            })
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.message || "Failed to update leave status");
          }

          const data = await res.json();
          const updated = data.leave || {};

          // Normalise status to our base statuses used in the UI
          const rawStatus = (updated.status || newStatus || "PENDING").toUpperCase();
          let baseStatus;
          if (rawStatus === "APPROVED") baseStatus = "Approved";
          else if (rawStatus === "REJECTED") baseStatus = "Rejected";
          else baseStatus = "Pending";

          req.status = baseStatus;
          req.approvedBy = updated.approved_by || null;
          req.approvedAt = updated.approved_at || null;

          // Optional: notify employee (if we know their username / staff id)
          if (req.username) {
            const fromDate = (req.from || req.from_date || "").toString().split("T")[0];
            const toDate = (req.to || req.to_date || "").toString().split("T")[0];

            addNotification({
              text:
                "Your leave request (" +
                fromDate +
                " ‚Üí " +
                toDate +
                ") was " +
                baseStatus,
              kind: "leave",
              indexRef: index,
              targetRole: "employee",
              targetUser: req.username
            });
          }

          renderLeave();
          renderNotifications();
        } catch (err) {
          console.error("handleLeaveAction error:", err);
          alert("Could not update leave status. Please try again.");
        }
      }

      // Close any open leave action menus when clicking outside
      document.addEventListener("click", function () {
        const menus = document.querySelectorAll(".leave-action-menu");
        menus.forEach((m) => m.classList.add("hidden"));
      });


      // Render leave requests
      function renderLeave() {
        leaveRows.innerHTML = "";

        const rows = leaveRequests;

        rows.forEach((req, index) => {
          const tr = document.createElement("tr");
          const tdIndex = document.createElement("td");
          const tdEmp = document.createElement("td");
          const tdPeriod = document.createElement("td");
          const tdReason = document.createElement("td");
          const tdStatus = document.createElement("td");

          tdIndex.textContent = (index + 1).toString();

          // displayName for both Employee & HR
          const name =
            req.displayName ||
            (req.userId ? `User #${req.userId}` : req.username || "-");
          tdEmp.textContent = name;

          const fromDate = (req.from_date || req.from || "").toString().split("T")[0];
          const toDate = (req.to_date || req.to || "").toString().split("T")[0];

          tdPeriod.textContent = `${fromDate} ‚Üí ${toDate}`;

          tdReason.textContent = req.reason;

          const statusInfo = formatStatus(req.status); // "Pending" | "Approved" | "Rejected"
          const statusPill = document.createElement("span");
          statusPill.classList.add("pill-status");
          if (statusInfo.cls) statusPill.classList.add(statusInfo.cls);
          statusPill.textContent = statusInfo.label;

          if (currentRole === "hr") {
            // HR sees inline actions (Approve / Reject / Reset) next to the status pill
            const wrapper = document.createElement("div");
            wrapper.classList.add("leave-actions-wrapper");
            wrapper.addEventListener("click", function (evt) {
              // prevent clicks inside from triggering the global close
              evt.stopPropagation();
            });

            wrapper.appendChild(statusPill);

            const toggleBtn = document.createElement("button");
            toggleBtn.type = "button";
            toggleBtn.classList.add("leave-action-toggle");
            toggleBtn.textContent = "‚ãØ";

            const menu = document.createElement("div");
            menu.classList.add("leave-action-menu", "hidden");

            const approveBtn = document.createElement("button");
            approveBtn.textContent = "Approve";
            approveBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              menu.classList.add("hidden");
              handleLeaveAction(index, "APPROVED");
            });

            const rejectBtn = document.createElement("button");
            rejectBtn.classList.add("leave-action-reject");
            rejectBtn.textContent = "Reject";
            rejectBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              menu.classList.add("hidden");
              handleLeaveAction(index, "REJECTED");
            });

            const resetBtn = document.createElement("button");
            resetBtn.textContent = "Reset to pending";
            resetBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              menu.classList.add("hidden");
              handleLeaveAction(index, "PENDING");
            });

            menu.appendChild(approveBtn);
            menu.appendChild(rejectBtn);
            menu.appendChild(resetBtn);

            toggleBtn.addEventListener("click", function (evt) {
              evt.stopPropagation();
              const isHidden = menu.classList.contains("hidden");
              // close other menus
              const menus = document.querySelectorAll(".leave-action-menu");
              menus.forEach((m) => m.classList.add("hidden"));
              if (isHidden) {
                menu.classList.remove("hidden");
              }
            });

            wrapper.appendChild(toggleBtn);
            wrapper.appendChild(menu);


            tdStatus.appendChild(wrapper);
          } else {
            // Employee view: just show the pill
            tdStatus.appendChild(statusPill);
          }

          tr.appendChild(tdIndex);
          tr.appendChild(tdEmp);
          tr.appendChild(tdPeriod);
          tr.appendChild(tdReason);
          tr.appendChild(tdStatus);

          leaveRows.appendChild(tr);
        });

        updateMetrics();
        updateReports();
      }

      // Render shift pools: "My assigned shifts" and "Available shifts"

      function renderShiftPools() {
        // My assigned shifts
        myShiftRows.innerHTML = "";
        const myList = getMyShifts();

        if (!currentUser || currentRole !== "employee") {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 2;
          td.textContent = "Log in as an Employee to see assigned shifts.";
          tr.appendChild(td);
          myShiftRows.appendChild(tr);
        } else if (myList.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 2;
          td.textContent = "No assigned shifts configured.";
          tr.appendChild(td);
          myShiftRows.appendChild(tr);
        } else {
          myList.forEach((s, index) => {
            const tr = document.createElement("tr");
            const tdIndex = document.createElement("td");
            const tdLabel = document.createElement("td");
            tdIndex.textContent = (index + 1).toString();

            // Badge if current user has a pending DROP or TRADE request for this assigned shift
            let labelText = s.label || `Shift #${s.id}`;
            const pendingForShift = shiftRequests.filter(r =>
              r.shiftId === s.id &&
              r.userId === (currentUser && currentUser.dbId) &&
              r.status === "Pending"
            );
            const hasAssignedPending = pendingForShift.some(r => r.type === "Drop" || r.type === "Trade");
            if (hasAssignedPending) {
              const r = pendingForShift.find(x => x.type === "Drop" || x.type === "Trade");
              const badgeText = r.type === "Drop" ? "DROP requested" : "TRADE requested";
              labelText += ` <span style="background: rgba(234, 179, 8, 0.2); color: #facc15; padding: 2px 8px; border-radius: 999px; font-size: 10px; margin-left: 6px;">${badgeText}</span>`;
            }

            tdLabel.innerHTML = labelText;
            tr.appendChild(tdIndex);
            tr.appendChild(tdLabel);
            myShiftRows.appendChild(tr);
          });
        }

        // Available shifts
        availableShiftRows.innerHTML = "";
        if (availableShifts.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = currentRole === "hr" ? 3 : 2;
          td.textContent = "No available shifts at the moment.";
          tr.appendChild(td);
          availableShiftRows.appendChild(tr);
        } else {
          availableShifts.forEach((s, index) => {
            const tr = document.createElement("tr");
            const tdIndex = document.createElement("td");
            const tdLabel = document.createElement("td");


            tdIndex.textContent = (index + 1).toString();

            // Badge if current user has a pending PICK_UP request for this available shift
            // or a pending TRADE request that exposes this shift for trade (we mark via s.isTrade from loadShiftsForCurrentUser)
            let labelText = s.label || `Shift #${s.id}`;

            const pendingForShift = shiftRequests.filter(r =>
              r.shiftId === s.id &&
              r.userId === (currentUser && currentUser.dbId) &&
              r.status === "Pending"
            );

            const pickUpPending = pendingForShift.some(r => r.type === "Pick up");
            const tradePending = s.isTrade === true; // already computed when loading avail shifts

            if (pickUpPending) {
              labelText += ` <span style="background: rgba(34, 197, 94, 0.18); color: #86efac; padding: 2px 8px; border-radius: 999px; font-size: 10px; margin-left: 6px;">PICK UP requested</span>`;
            }
            if (tradePending) {
              labelText += ` <span style="background: rgba(234, 179, 8, 0.3); color: #facc15; padding: 2px 8px; border-radius: 999px; font-size: 10px; margin-left: 6px;">TRADE</span>`;
            }

            tdLabel.innerHTML = labelText;

            tr.appendChild(tdIndex);
            tr.appendChild(tdLabel);

            if (currentRole === "hr") {
              const tdActions = document.createElement("td");
              const delBtn = document.createElement("button");
              delBtn.classList.add("btn-small");
              delBtn.textContent = "Delete";
              delBtn.addEventListener("click", async function () {
                if (!confirm("Delete this shift?")) return;
                try {
                  await deleteShiftApi(s.id);
                  await loadShiftsForCurrentUser();
                  renderShiftPools();
                  populateShiftOptions();
                  alert("Shift deleted successfully!");
                } catch (err) {
                  console.error("Delete shift failed:", err);
                  alert("Could not delete shift: " + err.message);
                }
              });
              tdActions.appendChild(delBtn);
              tr.appendChild(tdActions);
            }

            availableShiftRows.appendChild(tr);
          });
        }
      }

      // Populate shift options based on selected action
      function populateShiftOptions() {
        const action = shiftActionSelect.value;
        let list = [];

        if (action === "Trade") {
          list = assignedShifts;  // trade FOR available shifts
        } else if (action === "Pick up") {
          list = availableShifts;
        } else if (action === "Drop") {
          list = assignedShifts;  // drop FROM assigned shifts
        }

        shiftSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "-- Select shift --";
        shiftSelect.appendChild(placeholder);

        list.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.label;
          shiftSelect.appendChild(opt);
        });
      }

      // Delete shift API call for HR
      async function deleteShiftApi(shiftId) {
        if (!currentUser || currentRole !== "hr") return;

        if (!shiftId || Number.isNaN(parseInt(shiftId, 10))) {
          throw new Error("Invalid shift ID");
        }

        const res = await fetch(`/api/shifts/${shiftId}`, { method: "DELETE" });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.message || `HTTP ${res.status}: Shift not found or already deleted`);
        }
      }

      // Load employees from backend for HR shift dropdown + reports
      async function loadEmployeesForHr() {
        if (!currentUser || currentRole !== "hr") return;

        try {
          const res = await fetch("/api/users/employees"); // backend endpoint
          if (!res.ok) {
            throw new Error("Failed to fetch employee list");
          }

          const data = await res.json();
          const employees = data.employees || [];

          // Reset cache
          hrEmployees.length = 0;

          employees.forEach((u) => {
            const fullName = [u.first_name, u.last_name].filter(Boolean).join(" ");
            hrEmployees.push({
              dbId: u.id,                              // numeric users.id
              staffId: u.user_id,                      // staff login id
              fullName: fullName || u.user_id || "User",
            });
          });

          // Now refresh the dropdowns
          populateHrEmployeeSelect();
        } catch (err) {
          console.error("loadEmployeesForHr error:", err);
        }
      }

      // Populate HR shift employee select dropdown
      function populateHrEmployeeSelect() {
        // Clear HR shift employee select
        hrShiftEmployee.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "-- Select employee --";
        hrShiftEmployee.appendChild(placeholder);

        // Clear employee-report select as well
        if (employeeReportSelect) {
          employeeReportSelect.innerHTML = "";
          const ph2 = document.createElement("option");
          ph2.value = "";
          ph2.textContent = "-- Select employee --";
          employeeReportSelect.appendChild(ph2);
        }

        // Use employees loaded from backend
        hrEmployees.forEach((emp) => {
          // For HR shift form: we want the DB id to create shifts in backend
          const opt = document.createElement("option");
          opt.value = String(emp.dbId);              // numeric users.id
          opt.textContent = emp.fullName + " (" + emp.staffId + ")";
          hrShiftEmployee.appendChild(opt);

          // For the reports dropdown we can reuse the same list
          if (employeeReportSelect) {
            const opt2 = document.createElement("option");
            opt2.value = String(emp.dbId);          // we can still use dbId here
            opt2.textContent = emp.fullName + " (" + emp.staffId + ")";
            employeeReportSelect.appendChild(opt2);
          }
        });
      }

      // Store for PDF download
      let lastReportUserId = null;
      let lastReportUserName = null;

      // Helper functions for PDF generation
      function formatDatePretty(d) {
        return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
      }

      function formatTimePretty(d) {
        return d.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: false });
      }

      function isWithinLast7Days(dateObj) {
        const now = new Date();
        const start = new Date(now);
        start.setDate(now.getDate() - 6);
        start.setHours(0, 0, 0, 0);
        const d = new Date(dateObj);
        return d >= start && d <= now;
      }

      function buildAttendanceSummaryRowsForUser(userDbId) {
        const userRows = attendanceLog
          .filter(e => e.userId === userDbId)
          .map(e => ({ ...e, _dt: new Date(e.time) }))
          .filter(e => e._dt instanceof Date && !isNaN(e._dt))
          .filter(e => isWithinLast7Days(e._dt))
          .sort((a, b) => a._dt - b._dt);

        const byDay = new Map();
        userRows.forEach(e => {
          const key = e._dt.toDateString();
          if (!byDay.has(key)) byDay.set(key, []);
          byDay.get(key).push(e);
        });

        const summary = [];
        for (const [key, events] of byDay.entries()) {
          const ins = events.filter(x => x.type === "in");
          const outs = events.filter(x => x.type === "out");
          const inEvent = ins.length ? ins[0] : null;
          const outEvent = outs.length ? outs[outs.length - 1] : null;
          const dateObj = inEvent?._dt || outEvent?._dt || new Date(key);
          const dateLabel = formatDatePretty(dateObj);
          const inTime = inEvent ? formatTimePretty(inEvent._dt) : "‚Äî";
          const outTime = outEvent ? formatTimePretty(outEvent._dt) : "‚Äî";
          let status = "In Progress";
          let durationMinutes = null;
          if (inEvent && outEvent) {
            status = "Completed";
            durationMinutes = Math.max(0, Math.round((outEvent._dt - inEvent._dt) / 60000));
          }
          summary.push({ dateLabel, inTime, outTime, status, durationMinutes });
        }
        summary.sort((a, b) => new Date(b.dateLabel) - new Date(a.dateLabel));
        return summary;
      }

      function minutesToHoursMinutes(mins) {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return `${h}h ${m}m`;
      }

      // Generate employee report
      function generateEmployeeReport(employeeIdStr) {
        const empId = parseInt(employeeIdStr, 10);
        if (!empId || Number.isNaN(empId)) {
          employeeReportOutput.innerHTML = "Invalid employee.";
          lastReportUserId = null;
          lastReportUserName = null;
          if (downloadReportBtn) downloadReportBtn.classList.add("hidden");
          return;
        }

        let empMeta = null;
        if (Array.isArray(hrEmployees) && hrEmployees.length > 0) {
          empMeta = hrEmployees.find((e) => e.dbId === empId) || null;
        }

        const empName = empMeta ? empMeta.fullName : `User #${empId}`;
        const empStaffId = empMeta && empMeta.staffId ? ` (${empMeta.staffId})` : "";

        // Store for PDF download
        lastReportUserId = empId;
        lastReportUserName = empName;

        // Show download button
        if (downloadReportBtn) downloadReportBtn.classList.remove("hidden");

        // ATTENDANCE: match by userId (and fall back to staffId if present)
        const empAttendance = attendanceLog.filter((e) => {
          if (e.userId === empId) return true;                // DB-backed entries
          if (empMeta && e.user === empMeta.staffId) return true; // fallback
          return false;
        });

        const totalAttendance = empAttendance.length;
        const clockIns = empAttendance.filter((e) => e.type === "in").length;
        const clockOuts = empAttendance.filter((e) => e.type === "out").length;

        let lastIn = "-";
        let lastOut = "-";
        for (let i = empAttendance.length - 1; i >= 0; i--) {
          if (lastIn === "-" && empAttendance[i].type === "in") {
            lastIn = empAttendance[i].time;
          }
          if (lastOut === "-" && empAttendance[i].type === "out") {
            lastOut = empAttendance[i].time;
          }
          if (lastIn !== "-" && lastOut !== "-") break;
        }

        // LEAVE: match by userId
        const empLeaves = leaveRequests.filter((r) => r.userId === empId);
        const totalLeaves = empLeaves.length;
        const leavesApproved = empLeaves.filter((r) => r.status === "Approved").length;
        const leavesPending = empLeaves.filter((r) => r.status === "Pending").length;
        const leavesRejected = empLeaves.filter((r) => r.status === "Rejected").length;

        // SHIFT REQUESTS: match by userId
        const empShiftReqs = shiftRequests.filter((r) => r.userId === empId);
        const totalShiftReqs = empShiftReqs.length;
        const shiftApproved = empShiftReqs.filter((r) => r.status === "Approved").length;
        const shiftPending = empShiftReqs.filter((r) => r.status === "Pending").length;
        const shiftRejected = empShiftReqs.filter((r) => r.status === "Rejected").length;

        const tradeCount = empShiftReqs.filter((r) => r.type === "Trade").length;
        const pickUpCount = empShiftReqs.filter((r) => r.type === "Pick up").length;
        const dropCount = empShiftReqs.filter((r) => r.type === "Drop").length;

        // We don't track per-employee assigned shifts globally yet in HR view
        const assignedCount = 0;
        const assignedListHtml = "<em>Assigned shifts per employee are not yet tracked in this prototype.</em>";

        // Recent leave requests (last 3)
        let recentLeavesHtml = "";
        if (empLeaves.length > 0) {
          const slice = empLeaves.slice(-3);
          recentLeavesHtml =
            "<ul>" +
            slice
              .map((r) => {
                const fromDate = (r.from || r.from_date || "").toString().split("T")[0];
                const toDate = (r.to || r.to_date || "").toString().split("T")[0];
                return (
                  "<li>" +
                  fromDate +
                  " ‚Üí " +
                  toDate +
                  " ‚Äì " +
                  r.reason +
                  " (" +
                  r.status +
                  ")" +
                  "</li>"
                );
              })
              .join("") +
            "</ul>";
        } else {
          recentLeavesHtml = "<em>No leave requests in this session.</em>";
        }

        // Recent shift requests (last 3)
        let recentShiftsHtml = "";
        if (empShiftReqs.length > 0) {
          const slice2 = empShiftReqs.slice(-3);
          recentShiftsHtml =
            "<ul>" +
            slice2
              .map((r) => {
                return (
                  "<li>" +
                  r.type +
                  " ‚Äì " +
                  (r.shiftLabel || "Shift") +
                  " (" +
                  r.status +
                  ")" +
                  "</li>"
                );
              })
              .join("") +
            "</ul>";
        } else {
          recentShiftsHtml = "<em>No shift requests in this session.</em>";
        }

        const html =
          "<strong>" +
          empName +
          empStaffId +
          "</strong><br/><br/>" +
          "<strong>Attendance</strong><br/>" +
          "<ul>" +
          "<li>Total records: " +
          totalAttendance +
          " (Clock-ins: " +
          clockIns +
          ", Clock-outs: " +
          clockOuts +
          ")</li>" +
          "<li>Last clock-in: " +
          lastIn +
          "</li>" +
          "<li>Last clock-out: " +
          lastOut +
          "</li>" +
          "</ul>" +
          "<strong>Leave &amp; Absence</strong><br/>" +
          "<ul>" +
          "<li>Total requests: " +
          totalLeaves +
          "</li>" +
          "<li>Approved: " +
          leavesApproved +
          ", Submitted: " +
          leavesPending +
          ", Denied: " +
          leavesRejected +
          "</li>" +
          "</ul>" +
          "<div style='margin-top:4px;'><em>Recent leave requests:</em><br/>" +
          recentLeavesHtml +
          "</div>" +
          "<br/><strong>Shift activity</strong><br/>" +
          "<ul>" +
          "<li>Current assigned shifts: " +
          assignedCount +
          "</li>" +
          "<li>Total shift requests: " +
          totalShiftReqs +
          " (Trade: " +
          tradeCount +
          ", Pick up: " +
          pickUpCount +
          ", Drop: " +
          dropCount +
          ")</li>" +
          "<li>Approved: " +
          shiftApproved +
          ", Submitted: " +
          shiftPending +
          ", Denied: " +
          shiftRejected +
          "</li>" +
          "</ul>" +
          "<div style='margin-top:4px;'><em>Current assigned shifts:</em><br/>" +
          assignedListHtml +
          "</div>" +
          "<div style='margin-top:4px;'><em>Recent shift requests:</em><br/>" +
          recentShiftsHtml +
          "</div>";

        employeeReportOutput.innerHTML = html;
      }

      // Employee report handler (HR only in practice)
      if (employeeReportForm) {
        employeeReportForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const employeeId = employeeReportSelect.value;
          if (!employeeId) {
            employeeReportOutput.innerHTML =
              "Please select an employee to generate a report.";
            // Hide download button when no employee selected
            if (downloadReportBtn) downloadReportBtn.classList.add("hidden");
            return;
          }
          generateEmployeeReport(employeeId);
        });
      }

      // Clear report when selection changes
      if (employeeReportSelect) {
        employeeReportSelect.addEventListener("change", function () {
          employeeReportOutput.innerHTML =
            "Select an employee to view a summary of their attendance, leave and shift activity for this session.";
          lastReportUserId = null;
          lastReportUserName = null;
          if (downloadReportBtn) downloadReportBtn.classList.add("hidden");
        });
      }

      // QR SCAN HANDLER ‚Äì this is where a real QR library would call into
      function handleQrScan(scannedId) {
        const id = (scannedId || "").trim();
        if (!id) {
          if (qrScanStatus) qrScanStatus.textContent = "No QR value provided.";
          return;
        }
        const emp = employees[id];
        if (!emp) {
          if (qrScanStatus) qrScanStatus.textContent = "Unknown QR / staff ID: " + id;
          return;
        }

        const status = getEmployeeStatus(id);
        const type = status.clockedIn ? "out" : "in";
        const now = new Date();

        attendanceLog.push({
          user: id,
          type: type,
          time: now.toLocaleString(),
        });

        status.clockedIn = !status.clockedIn;

        if (qrScanStatus) {
          const actionText = type === "in" ? "Clocked IN" : "Clocked OUT";
          qrScanStatus.textContent =
            emp.displayName + " ‚Äì " + actionText + " at " + now.toLocaleString();
        }

        renderAttendance();
        updateAttendanceControls();
      }

      // CAMERA START ‚Äì placeholder for real QR library
      function startQrCamera() {
        if (qrCameraContainer) {
          qrCameraContainer.textContent =
            "Camera scanner started (demo). In production, initialise your QR library here " +
            "and call handleQrScan(decodedText) whenever a QR code is successfully read.";
        }
        if (qrScanStatus) {
          qrScanStatus.textContent = "Camera scanner ready. Awaiting QR code...";
        }
      }

      // LOGIN LOGIC

      loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const selectedRole = roleSelect.value; // "employee" or "hr" from the UI toggle

        loginError.classList.add("hidden");
        loginError.textContent = "";

        try {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // üîπ match authController: { userId, password }
            body: JSON.stringify({ userId: username, password })
          });

          if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            loginError.textContent =
              errData.message || "Invalid credentials. Please check role, username and password.";
            loginError.classList.remove("hidden");
            return;
          }

          const data = await response.json();
          const user = data.user; // this is the payload from authController
          const roleFromDb = user.roleId === 2 ? "hr" : "employee";
          const displayNameParts = [user.firstName, user.lastName].filter(Boolean);
          const displayName = displayNameParts.join(" ") || user.userId;

          currentRole = roleFromDb;
          currentUser = {
            role: roleFromDb,
            username: user.userId,
            dbId: user.id,
            displayName: displayName,
            roleId: user.roleId,
            departmentId: user.departmentId
          };

          // ensure HR sees Reports + Download PDF
          applyRoleVisibility();

          userRoleLabel.textContent = currentRole === "employee" ? "Employee" : "HR / Admin";
          userNameLabel.textContent = currentUser.displayName;

          const reportsLink = document.querySelector('.nav-link[data-target="reports"]');
          if (currentRole === "hr") {
            if (reportsLink) reportsLink.classList.remove("hidden");
            attendanceEntryBlock.classList.add("hidden");
            newShiftRequestSection.classList.add("hidden");
            hrCreateShiftSection.classList.remove("hidden");
            shiftRequestsHeading.textContent = "All shift requests (this session)";
            if (leaveFormSection) leaveFormSection.classList.add("hidden");
          } else {
            if (reportsLink) reportsLink.classList.add("hidden");
            attendanceEntryBlock.classList.remove("hidden");
            hrCreateShiftSection.classList.add("hidden");
            newShiftRequestSection.classList.remove("hidden");
            shiftRequestsHeading.textContent = "Your shift requests (this session)";
            if (leaveFormSection) leaveFormSection.classList.remove("hidden");
          }

          loginScreen.classList.add("hidden");
          dashboardScreen.classList.remove("hidden");
          showView("dashboard");

          // Load existing attendance from DB 
          await loadAttendanceForCurrentUser();
          // Load existing leave requests from DB
          await loadLeaveForCurrentUser();

          // HR: load employees list for the "Select employee" dropdown + reports
          if (currentRole === "hr") {
            await loadEmployeesForHr();
          }
          // load shifts for current user (both roles)
          await loadShiftsForCurrentUser();

          // load shift requests for current user
          await loadShiftRequestsForCurrentUser();


          renderShifts();
          renderShiftPools();
          populateShiftOptions();
          updateAttendanceControls();
          renderNotifications();
          updateReports();
        } catch (err) {
          console.error("Login error:", err);
          loginError.textContent = "Login failed due to a server error.";
          loginError.classList.remove("hidden");
        }
      });

      // NAVIGATION
      navLinks.forEach((link) => {
        link.addEventListener("click", function () {
          const target = link.dataset.target;
          showView(target);
        });
      });

      // NOTIFICATION TOGGLE
      notifBtn.addEventListener("click", function () {
        notifDropdown.classList.toggle("hidden");

        // When employees open the bell, mark their notifications as seen
        if (!notifDropdown.classList.contains("hidden") && currentRole === "employee" && currentUser) {
          notifications.forEach((n) => {
            if (n.targetRole === "employee" && n.targetUser === currentUser.username) {
              n.seen = true;
            }
          });
          renderNotifications();
        }
      });

      // ATTENDANCE HANDLER (Employees only, one-time per state)
      attendanceForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!currentUser || currentRole !== "employee") return;

        const action = document.querySelector('input[name="attendance-action"]:checked');
        if (!action) return;

        const type = action.value; // "in" / "out"
        const status = getEmployeeStatus(currentUser.username);

        // Prevent invalid sequences
        if (type === "in" && status.clockedIn) {
          alert("You are already clocked in. Please clock out first.");
          return;
        }
        if (type === "out" && !status.clockedIn) {
          alert("You are not clocked in. Please clock in first.");
          return;
        }

        try {
          // Save to DB
          const log = await saveAttendanceToServer({
            userDbId: currentUser.dbId,  // numeric users.id
            eventType: type,             // "in" or "out"
            source: "WEB_FORM",
            qrValue: null
          });

          const timeString = log.recorded_at || new Date().toISOString();

          attendanceLog.push({
            user: currentUser.username,
            userId: currentUser.dbId,
            displayName: currentUser.displayName,
            type: type,
            time: timeString,  // ‚úÖ ISO format
            hoursWorked: log.hoursWorked || null
          });


          // Update state (clocked in/out)
          status.clockedIn = type === "in";

          // Show success message
          const actionText = type === "in" ? "clocked in" : "clocked out";
          const timeDisplay = new Date(log.recorded_at || new Date()).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
          alert(`‚úì Successfully ${actionText} at ${timeDisplay}`);


          renderAttendance();
          updateAttendanceControls();
          updateReports();
        } catch (err) {
          console.error("Attendance save failed:", err);
          alert("Could not save attendance. Please try again.");
        }
      });

      // LEAVE HANDLER (Employees only)
      leaveForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!currentUser || currentRole !== "employee") return;

        const from = document.getElementById("leave-from").value;
        const to = document.getElementById("leave-to").value;
        const reason = document.getElementById("leave-reason").value.trim();

        if (!from || !to || !reason) {
          alert("Please fill in all fields for the leave request.");
          return;
        }

        // Make sure we have the DB id from login
        if (!currentUser.dbId) {
          console.error("No dbId on currentUser; cannot submit leave request.");
          alert("Unable to submit leave request (missing user id). Please log in again.");
          return;
        }

        try {
          // Save to backend
          const res = await fetch("/api/leave", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: currentUser.dbId, // numeric users.id
              fromDate: from,          // "YYYY-MM-DD"
              toDate: to,              // "YYYY-MM-DD"
              reason: reason
            })
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.message || "Failed to submit leave request");
          }

          const data = await res.json();
          const lv = data.leave; // row returned from the DB

          // Map DB row -> frontend structure
          let statusBase;
          switch ((lv.status || "").toUpperCase()) {
            case "APPROVED":
              statusBase = "Approved";
              break;
            case "REJECTED":
              statusBase = "Rejected";
              break;
            case "PENDING":
            default:
              statusBase = "Pending";
              break;
          }

          const newReq = {
            // include username/displayName/userId so renderLeave can show the employee name
            user: currentUser.username,
            username: currentUser.username,
            userId: currentUser.dbId || null,
            displayName: currentUser.displayName,
            from: (lv.from_date || from).split("T")[0],
            to: (lv.to_date || to).split("T")[0],
            reason: lv.reason || reason,
            status: statusBase,
            submittedAt: lv.submitted_at ? lv.submitted_at.split("T")[0] : null,
          };

          // Keep in-memory list so it shows in table & reports
          leaveRequests.push(newReq);
          const indexRef = leaveRequests.length - 1;

          // Notify HR via bell
          const displayName = currentUser.displayName;
          addNotification({
            text: displayName + " ‚Äì Leave request (" + newReq.from + " ‚Üí " + newReq.to + ")",
            kind: "leave",
            indexRef: indexRef,
            targetRole: "hr",
          });

          renderLeave();
          updateReports();
          leaveForm.reset();
        } catch (err) {
          console.error("Leave submit failed:", err);
          alert("Could not submit leave request. Please try again.");
        }
      });

      // Helpers to map UI shift request action -> DB enums
      function toDbShiftRequestType(uiType) {
        const t = (uiType || "").toLowerCase();
        if (t.includes("pick")) return "PICK_UP";
        if (t.includes("drop")) return "DROP";
        return "TRADE";
      }

      function inferShiftRequestSource(uiType) {
        // Simple rule: picking up from available shifts ‚Üí AVAILABLE; others ‚Üí ASSIGNED
        const t = (uiType || "").toLowerCase();
        if (t.includes("pick")) return "AVAILABLE";
        return "ASSIGNED";
      }


      // SHIFT REQUEST HANDLER (employee, DB-backed)
      if (shiftForm) {
        shiftForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          if (!currentUser || currentRole !== "employee") return;

          if (!currentUser.dbId) {
            alert("Missing user id. Please log in again.");
            return;
          }

          const action = shiftActionSelect.value;   // "Trade" | "Pick up" | "Drop"
          const selectedShiftId = shiftSelect.value;
          const note = shiftNote.value.trim();

          if (!selectedShiftId) {
            alert("Please select a shift.");
            return;
          }

          // Determine which pool to use based on action
          let pool = [];
          let sourcePool = "ASSIGNED";

          if (action === "Trade") {
            pool = availableShifts;  // choosing what you want to trade for
            sourcePool = "AVAILABLE";
          } else if (action === "Pick up") {
            pool = availableShifts;
            sourcePool = "AVAILABLE";
          } else if (action === "Drop") {
            pool = assignedShifts;
            sourcePool = "ASSIGNED";
          }

          const selected = pool.find((s) => String(s.id) === String(selectedShiftId));
          if (!selected) {
            alert("Selected shift not found.");
            return;
          }

          const shiftId = selected.id;
          const requestType = toDbShiftRequestType(action);   // PICK_UP / DROP / TRADE

          try {
            const res = await fetch("/api/shift-requests", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                userId: currentUser.dbId,
                shiftId: shiftId,
                requestType,
                note,
                source: sourcePool,  // what pool this request is about
              }),
            });

            if (!res.ok) {
              const errData = await res.json().catch(() => ({}));
              throw new Error(errData.message || "Failed to submit shift request");
            }

            const data = await res.json();
            const sr = data.shiftRequest;

            // Normalise status
            const rawStatus = (sr.status || "PENDING").toUpperCase();
            let baseStatus;
            if (rawStatus === "APPROVED") baseStatus = "Approved";
            else if (rawStatus === "REJECTED") baseStatus = "Rejected";
            else baseStatus = "Pending";

            // Map DB type back to UI label
            let typeLabel;
            switch ((sr.request_type || requestType).toUpperCase()) {
              case "PICK_UP":
                typeLabel = "Pick up";
                break;
              case "DROP":
                typeLabel = "Drop";
                break;
              default:
                typeLabel = "Trade";
            }

            const newReq = {
              id: sr.id,
              userId: sr.user_id,
              user: currentUser.username,
              userDisplayName: currentUser.displayName,
              type: typeLabel,
              shiftId: sr.shift_id,
              shiftLabel: selected.label || `Shift #${sr.shift_id}`,
              note: sr.note || note || null,
              status: baseStatus,
              source: sr.source,
              createdAt: sr.created_at,
            };

            const indexRef = shiftRequests.push(newReq) - 1;

            // Notify HR
            addNotification({
              text:
                currentUser.displayName +
                " ‚Äì " +
                typeLabel +
                " request for shift: " +
                newReq.shiftLabel,
              kind: "shift",
              indexRef,
              targetRole: "hr",
            });

            alert(`${typeLabel} request submitted successfully!`);
            renderShifts();
            updateReports();
            shiftForm.reset();

            // Reload latest requests and shifts so badges reflect ‚Äú‚Ä¶ requested‚Äù
            await loadShiftRequestsForCurrentUser();
            await loadShiftsForCurrentUser();

            alert(`${action} request submitted successfully!`);
            shiftForm.reset();
            populateShiftOptions();
            renderShiftPools();
          } catch (err) {
            console.error("Shift request submit failed:", err);
            alert("Could not submit shift request: " + err.message);
          }
        });
      }

      // HR: create shifts for employees (DB-backed, no employeeShiftPools)

      hrShiftForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!currentUser || currentRole !== "hr") return;

        const empIdStr = hrShiftEmployee.value;
        const desc = hrShiftDesc.value.trim();

        if (!desc) {
          alert("Please enter a shift description.");
          return;
        }

        const assignedToId = empIdStr ? parseInt(empIdStr, 10) : null;

        try {
          const res = await fetch("/api/shifts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              description: desc,
              assignedToId: assignedToId,
              status: "AVAILABLE",
            })
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.message || `HTTP ${res.status}`);
          }

          const data = await res.json();
          console.log("Shift created:", data);
          const assignedLabel =
            assignedToId && hrShiftEmployee.selectedIndex > 0
              ? hrShiftEmployee.options[hrShiftEmployee.selectedIndex].textContent
              : null;

          const msg = assignedLabel
            ? `Shift created and assigned to ${assignedLabel}.`
            : "Shift created as AVAILABLE (no employee selected).";

          alert(msg);
          hrShiftForm.reset();
          hrShiftEmployee.value = "";
          // Refresh shifts
          await loadShiftsForCurrentUser();
          renderShiftPools();
          populateShiftOptions();
        } catch (err) {
          console.error("Failed to create shift:", err);
          alert("Could not create shift: " + err.message);
        }
      });

      // Shift action change -> refresh list of shifts to choose from
      shiftActionSelect.addEventListener("change", populateShiftOptions);

      // QR simulate button
      if (qrSimBtn) {
        qrSimBtn.addEventListener("click", function () {
          handleQrScan(qrSimInput.value);
        });
      }

      // QR camera button
      if (qrCameraBtn) {
        qrCameraBtn.addEventListener("click", function () {
          startQrCamera();
        });
      }


      // Show/hide Reports tab and PDF button based on role
      function applyRoleVisibility() {
        const reportsLink = document.querySelector('.nav-link[data-target="reports"]');
        if (currentRole === "hr") {
          if (reportsLink) reportsLink.classList.remove("hidden");
          if (downloadReportBtn) downloadReportBtn.classList.remove("hidden");
        } else {
          if (reportsLink) reportsLink.classList.add("hidden");
          if (downloadReportBtn) downloadReportBtn.classList.add("hidden");
        }
      }

      // Call after login role is set
      // In login success handler, after setting currentRole/currentUser:
      applyRoleVisibility();

      // Also call when toggling views or roles:
      toggleEmployee.addEventListener("click", function (e) {
        e.preventDefault();
        switchRole("employee");
        applyRoleVisibility();
      });
      toggleHr.addEventListener("click", function (e) {
        e.preventDefault();
        switchRole("hr");
        applyRoleVisibility();
      });

      // PDF export handler (unchanged)
      if (downloadReportBtn) {
        downloadReportBtn.classList.add("hidden");
        downloadReportBtn.addEventListener("click", function () {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ unit: "pt", format: "a4" });

          let userId, employeeName, empStaffId;

          if (currentRole === "employee") {
            userId = currentUser.dbId;
            employeeName = currentUser.displayName;
            empStaffId = currentUser.username ? ` (${currentUser.username})` : "";
          } else {
            if (!lastReportUserId) {
              alert("Generate a report first.");
              return;
            }
            userId = lastReportUserId;
            employeeName = lastReportUserName || `User #${userId}`;

            // Get staff ID from hrEmployees - MOVED HERE BEFORE USING IT
            const empMeta = hrEmployees.find(e => e.dbId === userId);
            empStaffId = empMeta && empMeta.staffId ? ` (${empMeta.staffId})` : "";
          }

          // NOW GET THE DATA - after userId is set
          const empAttendance = attendanceLog.filter(e => e.userId === userId);
          const empLeaves = leaveRequests.filter(r => r.userId === userId);
          const empShiftReqs = shiftRequests.filter(r => r.userId === userId);

          let y = 40;

          // HEADER
          doc.setFontSize(16);
          doc.setFont(undefined, 'bold');
          doc.text("K.R.O.N.O.S ‚Äì Employee Report", 40, y);
          y += 25;

          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text(`Employee: ${employeeName}${empStaffId}`, 40, y);
          y += 16;
          doc.text(`Generated: ${new Date().toLocaleString()}`, 40, y);
          y += 25;

          // SECTION 1: ATTENDANCE
          doc.setFontSize(13);
          doc.setFont(undefined, 'bold');
          doc.text("Attendance Summary", 40, y);
          y += 16;

          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');

          const totalAttendance = empAttendance.length;
          const clockIns = empAttendance.filter(e => e.type === "in").length;
          const clockOuts = empAttendance.filter(e => e.type === "out").length;

          let lastIn = "-";
          let lastOut = "-";
          for (let i = empAttendance.length - 1; i >= 0; i--) {
            if (lastIn === "-" && empAttendance[i].type === "in") {
              lastIn = empAttendance[i].time;
            }
            if (lastOut === "-" && empAttendance[i].type === "out") {
              lastOut = empAttendance[i].time;
            }
            if (lastIn !== "-" && lastOut !== "-") break;
          }

          doc.text(`‚Ä¢ Total records: ${totalAttendance} (Clock-ins: ${clockIns}, Clock-outs: ${clockOuts})`, 40, y);
          y += 14;
          doc.text(`‚Ä¢ Last clock-in: ${lastIn}`, 40, y);
          y += 14;
          doc.text(`‚Ä¢ Last clock-out: ${lastOut}`, 40, y);
          y += 20;

          // Attendance table (last 7 days)
          doc.setFontSize(11);
          doc.setFont(undefined, 'bold');
          doc.text("Last 7 Days Detail", 40, y);
          y += 14;

          const rows = buildAttendanceSummaryRowsForUser(userId);

          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          doc.text("Date", 40, y);
          doc.text("In", 140, y);
          doc.text("Out", 220, y);
          doc.text("Duration", 300, y);
          doc.text("Status", 380, y);
          y += 12;

          let totalMinutes = 0;

          if (rows.length === 0) {
            doc.text("No attendance records in last 7 days.", 40, y);
            y += 12;
          } else {
            rows.forEach(r => {
              if (y > 760) {
                doc.addPage();
                y = 40;
              }

              doc.text(r.dateLabel, 40, y);
              doc.text(r.inTime, 140, y);
              doc.text(r.outTime, 220, y);

              const duration = r.durationMinutes == null ? "‚Äî" : minutesToHoursMinutes(r.durationMinutes);
              doc.text(duration, 300, y);
              doc.text(r.status, 380, y);
              y += 12;

              if (r.durationMinutes != null) {
                totalMinutes += r.durationMinutes;
              }
            });
          }

          y += 6;
          doc.setFont(undefined, 'bold');
          doc.text(`Total hours (last 7 days): ${minutesToHoursMinutes(totalMinutes)}`, 40, y);
          y += 25;

          // SECTION 2: LEAVE & ABSENCE
          if (y > 680) {
            doc.addPage();
            y = 40;
          }

          doc.setFontSize(13);
          doc.setFont(undefined, 'bold');
          doc.text("Leave & Absence", 40, y);
          y += 16;

          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');

          const totalLeaves = empLeaves.length;
          const leavesApproved = empLeaves.filter(r => r.status === "Approved").length;
          const leavesPending = empLeaves.filter(r => r.status === "Pending").length;
          const leavesRejected = empLeaves.filter(r => r.status === "Rejected").length;

          doc.text(`‚Ä¢ Total requests: ${totalLeaves}`, 40, y);
          y += 14;
          doc.text(`‚Ä¢ Approved: ${leavesApproved}, Submitted: ${leavesPending}, Denied: ${leavesRejected}`, 40, y);
          y += 18;

          if (empLeaves.length > 0) {
            doc.setFont(undefined, 'bold');
            doc.text("Recent Leave Requests:", 40, y);
            y += 14;

            doc.setFont(undefined, 'normal');
            const recentLeaves = empLeaves.slice(-5);
            recentLeaves.forEach(r => {
              if (y > 760) {
                doc.addPage();
                y = 40;
              }
              const fromDate = (r.from || r.from_date || "").toString().split("T")[0];
              const toDate = (r.to || r.to_date || "").toString().split("T")[0];
              doc.text(`‚Ä¢ ${fromDate} ‚Üí ${toDate} ‚Äì ${r.reason} (${r.status})`, 45, y);
              y += 12;
            });
          } else {
            doc.text("No leave requests in this session.", 40, y);
            y += 12;
          }

          y += 20;

          // SECTION 3: SHIFT ACTIVITY
          if (y > 680) {
            doc.addPage();
            y = 40;
          }

          doc.setFontSize(13);
          doc.setFont(undefined, 'bold');
          doc.text("Shift Activity", 40, y);
          y += 16;

          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');

          const assignedCount = currentRole === "employee" ? assignedShifts.length : 0;
          const totalShiftReqs = empShiftReqs.length;
          const shiftApproved = empShiftReqs.filter(r => r.status === "Approved").length;
          const shiftPending = empShiftReqs.filter(r => r.status === "Pending").length;
          const shiftRejected = empShiftReqs.filter(r => r.status === "Rejected").length;

          const tradeCount = empShiftReqs.filter(r => r.type === "Trade").length;
          const pickUpCount = empShiftReqs.filter(r => r.type === "Pick up").length;
          const dropCount = empShiftReqs.filter(r => r.type === "Drop").length;

          doc.text(`‚Ä¢ Current assigned shifts: ${currentRole === "employee" ? assignedShifts.length : "N/A"}`, 40, y);
          y += 14;
          doc.text(`‚Ä¢ Total shift requests: ${totalShiftReqs} (Trade: ${tradeCount}, Pick up: ${pickUpCount}, Drop: ${dropCount})`, 40, y);
          y += 14;
          doc.text(`‚Ä¢ Approved: ${shiftApproved}, Submitted: ${shiftPending}, Denied: ${shiftRejected}`, 40, y);
          y += 18;

          if (empShiftReqs.length > 0) {
            doc.setFont(undefined, 'bold');
            doc.text("Recent Shift Requests:", 40, y);
            y += 14;

            doc.setFont(undefined, 'normal');
            const recentShifts = empShiftReqs.slice(-5);
            recentShifts.forEach(r => {
              if (y > 760) {
                doc.addPage();
                y = 40;
              }
              const shiftLabel = r.shiftDescription || r.shiftLabel || `Shift #${r.shiftId}`;
              doc.text(`‚Ä¢ ${r.type} ‚Äì ${shiftLabel} (${r.status})`, 45, y);
              if (r.note) {
                y += 11;
                doc.setFontSize(9);
                doc.text(`  Note: ${r.note}`, 50, y);
                doc.setFontSize(10);
              }
              y += 12;
            });
          } else {
            doc.text("No shift requests in this session.", 40, y);
            y += 12;
          }

          doc.save(`KRONOS_Report_${employeeName.replace(/\s+/g, "_")}.pdf`);
        });
      }

      // Initial state
      showView("dashboard");
      updateMetrics();
      updateReports();
      renderNotifications();
      renderShiftPools();
      populateShiftOptions();
      populateHrEmployeeSelect();
      switchRole("employee");
      renderAttendance();
      updateAttendanceControls();

      // Hide Reports tab by default (no user yet)
      const reportsLinkInit = document.querySelector('.nav-link[data-target="reports"]');
      if (reportsLinkInit) reportsLinkInit.classList.add("hidden");
    })();




  </script>
</body>

</html>